<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: PLUMED Masterclass 22.2: Analysis of Plumed output by Metadynminer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.9.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('masterclass-22-02.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">PLUMED Masterclass 22.2: Analysis of Plumed output by Metadynminer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section author"><dt>Authors</dt><dd>Vojtech Spiwok </dd></dl>
<dl class="section date"><dt>Date</dt><dd>February 14, 2022</dd></dl>
<h1><a class="anchor" id="masterclass-22-02-aims"></a>
Aims</h1>
<p>The aim of this Masterclass is to introduce users to the R package Metadynminer for analysis of results from metadynamics in Plumed.</p>
<h1><a class="anchor" id="masterclass-22-02-lo"></a>
Objectives</h1>
<p>Once this Masterclass is completed, users will be able to:</p>
<ul>
<li>Install R and its packages.</li>
<li>Load metadynamics results (<code>HILLS</code> file) to Metadynminer.</li>
<li>Calculate a free energy surface and plot it in a publication quality.</li>
<li>Locate free energy minima and evaluate their relative free energies.</li>
<li>Make an animation of the evolution of a free energy surface.</li>
<li>Use data in Metadynminer objects to do advanced calculations (e.g., reweighting).</li>
</ul>
<h1><a class="anchor" id="masterclass-22-02-install"></a>
Setting up the software</h1>
<h2><a class="anchor" id="masterclass-22-02-rinstall"></a>
Installation</h2>
<p>We will use <a href="https://www.r-project.org/">R</a> installed from <a href="https://cloud.r-project.org/">CRAN</a>. Go to <a href="https://cloud.r-project.org/">CRAN</a> and follow the installation instructions for your operating system. R is Open Source. It is not necessary to use a graphical user interface but it is very useful, especially for making illustrations.</p>
<p>If you plan to use a graphical user interface, the best option is <a href="https://www.rstudio.com/">Rstudio</a>. <a href="https://www.rstudio.com/products/rstudio/">Desktop version of Rstudio</a> is Open Source. Follow the installation instructions for your operating system.</p>
<p>To install metadynminer, open R (in commandline type <code>R</code> or open GUI by typing <code>rstudio</code> or using an icon) and type:</p>
<pre class="fragment">install.packages("metadynminer")
</pre><p>The output should contain: <code>* DONE (metadynminer)</code>. If you have an output: <code>installation of package metadynminer had non-zero exit status</code> there was a problem with installation. You may try:</p>
<ul>
<li>On MS Windows install <code>Rtools</code>.</li>
<li>If you have permission issues, you can try the commands <code>Sys.getenv("R_HOME")</code> and <code>Sys.getenv("R_LIBS_USER")</code> and check the permission of the printed directories. You may change installation directories by corresponding <code>Sys.setenv(...)</code> commands.</li>
</ul>
<p>You may check whether Metadynminer was installed correctly by typing: </p><pre class="fragment">library(metadynminer)
</pre><p>This command should have no output. Installation is done only once (or can be repreated for version upgrades). Loading of the package by <code>library</code> command must be done in every R seance.</p>
<h1><a class="anchor" id="masterclass-22-02-resources"></a>
Resources</h1>
<p>The data needed for this Masterclass can be found on <a href="https://github.com/plumed/masterclass-22-02">GitHub</a>. You can clone this repository using the following command:</p>
<pre class="fragment">git clone https://github.com/plumed/masterclass-22-02.git
</pre><p>The repository contains hills and colvar files, respectively, from 10 or 1 ns metadynamics simulations of alanine dipeptide in water calculated in Plumed. Other input data are available from <a href="https://doi.org/10.5281/zenodo.6056060">Zenodo</a> but are not required in this tutorial. The repo contains:</p><ul>
<li><code>HILLS.cv12</code> and <code>COLVAR.cv12</code> - hills and collective variable + bias report from metadynamics with phi and psi dihedral angles</li>
<li><code>HILLS.cv1</code> and <code>COLVAR.cv1</code> - hills and collective variable + bias report from metadynamics with phi dihedral angle</li>
<li><code>HILLS.cv2</code> and <code>COLVAR.cv2</code> - hills and collective variable + bias report from metadynamics with psi dihedral angle</li>
</ul>
<p>This data are independent of Plumed version (for version &gt;=2.0).</p>
<h1><a class="anchor" id="masterclass-22-02-usingr"></a>
Using R</h1>
<p>R is a program and scrpting language predominantly developed for statistical data analysis. It is popular in statistics, economy, ecology, bioinformatics, and other fields. Let us quickly introduce R. Open R as described above and type: </p><pre class="fragment">1+1
2-1
3*3
5/2
</pre><p>This shows addition, subtraction, multiplication, and division. Numbers and other objects can be saved to variables. We advice users to avoid the names of variables that can be confused with existing functions in R. In this masterclass, we will use the prefix "my" (e.g., <code>myhills</code>) to avoid this. Variable names are case-sensitive. The operator used to save something to is an arrow <code>&lt;-</code> (less than followed by minus sign). You may see R codes with a normal equal sign, but we will be puristic in this. Let us show the variables in R: </p><pre class="fragment">x &lt;- 1+1
x
</pre><p>In the outputs above, there is an unexpected string <code>[1]</code>. This is the index of the first item on the line. This is useful when dealing with vectors. Vector can be created by implicitly typing its elements to the function <code>c()</code>, by <code>:</code> operator and other ways: </p><pre class="fragment">x &lt;- c(1, 3, 2)
x
x &lt;- 1:50
x
x &lt;- 50:1
x
</pre><p>R can also work with 2D and multidimensional matrices. R can work with strings (written in quotes, e.g. "blue"), Booleans (<code>TRUE</code> and <code>FALSE</code>, or shortened as <code>T</code> and <code>F</code>).</p>
<p>R uses functions written as the name of function followed by its arguments in brackets: </p><pre class="fragment">exp(1)
cos(pi)
</pre><p>Functions can be applied element-wise: </p><pre class="fragment">x&lt;-0:10
cos(x)
</pre><p>Functions with more variables use the specifications set by <code>=</code>, separated by <code>,</code>: </p><pre class="fragment">x&lt;-0:100/10
y&lt;-cos(x)
plot(x, y)
plot(x, y, xlab="x axis", ylab="y axis", ylim=c(-2,2))
</pre><p>Important difference from many other programming environments is that R can freely change number types, e.g. <code>3/2</code> is evaluated as 1.5, unlike Pyhton, which gives 1, because 3 and 2 are integers, and not floats.</p>
<p>Another important difference is that R uses indexes of vector items starting with 1 (not 0 line in C/C++, Python etc.). For example: </p><pre class="fragment">x &lt;- c("Carlo", "Gareth", "Giovanni", "Max")
x[2]
</pre><p> will return Gareth. In contrast, Python returns Giovanni: </p><pre class="fragment">x = ["Carlo", "Gareth", "Giovanni", "Max"]
x[2]
</pre><p>Finally, R can use other types of objects, including objects defined by a user. Their instances can be accessed by a string operator. For example, the function <code>prcomp</code> performs a principal component analysis. Its output is an object with multiple instances, for example, with a rotation matrix: </p><pre class="fragment">pcamodel &lt;- prcomp(outer(1:3,1:2))
pcamodel
pcamodel$rotation
</pre><p>Finally, to quit R you can use the function <code>q()</code>. The program asks the user whether he/she wants to save the data (i.e., variables created in the previous course of the run). We advise users to NOT save data, i.e. choose the option "n" or function <code>q(save="n")</code>.</p>
<h2><a class="anchor" id="masterclass-22-02-ex-1"></a>
Exercise 1: Calculation of the free energy surface from metadynamics hills</h2>
<p>Open R (in Rstudio or command line) and load Metadynminer: </p><pre class="fragment">library(metadynminer)
</pre><p> Now load the file <code>HILLS.cv12</code> into Metadynminer: </p><pre class="fragment">myhills12 &lt;- read.hills("HILLS.cv12", per=c(T, T))
</pre><p> At this point, it is necessary to set the periodicity of CVs. The free energy surface was calculated using torsion angles as CVs, which are periodic. It is necessary to set the periodicity to <code>TRUE</code> (or simplified as <code>T</code>) as a vector <code>per</code>. If you get an error message that the file was not found, it means that the home directory is not set properly. In Linux command line, the home is the directory where you start R by the command <code>R</code>. In Rstudio, you may navigate to the directory with the file using the File menu in the right bottom frame. Alternatively, you can use <code>getwd()</code> and <code>setwd("/path/to/your/dir")</code>.</p>
<p>Hills can be also loaded from a HILLS file posted online by replacing the file name by an URL.</p>
<p>To get help to any function in R, for example, <code>read.hills</code>, you can use either <code>help(read.hills)</code> or <code>?read.hills)</code>.</p>
<p>If you type the name of the hills file variable <code>myhills12</code> you get an information about the number of hills and CVs. The function <code>summary</code> (<code>summary(myhills12)</code>) returns the same information plus the ranges of CVs.</p>
<p>A hills file can be plotted by the <code>plot</code> function, i.e., <code>plot(myhills12)</code>. For a metadynamics with one CV it plots the evolution of the CV as a function of time. For a metadynamics with two CVs it plots a scatter plot with CV1 on the horizontal axis and CV2 on the vertical axis. The plot function applied on metadynamics hills file is an extension of the standard plot function in R. You may set parameters <code>xlab</code>, <code>ylab</code>, <code>main</code>, <code>sub</code>, <code>xlim</code>, <code>ylim</code>, <code>pch</code>, <code>col</code>, <code>bg</code>, <code>cex</code>, <code>lwd</code> and <code>asp</code> (see <code>?plot.hillsfile</code>). It is possible to stack plots on top of each other by using the command <code>plot(...)</code>, followed by a command <code>points(...)</code> or <code>lines(...)</code>.</p>
<p>For well-tempered metadynamics, it may be useful to check the evolution of heights of hills. This can be done by the command: </p><pre class="fragment">plotheights(myhills12)
</pre><p>Hills files are often obtained from multiple metadynamics runs. This may cause that time collumn does not correspond to the real time. The option <code>ignoretime=T</code> used either in <code>read.hills</code> or in <code>plotheights</code> replaces time by the hill number.</p>
<p>The main point is the calculation of the free energy surface from the hills file as an negatve image of the sum of Gaussian hills (scaled in well-tempered metadynamics, which is pre-scaled in the Plumed output).</p>
<p>This may be time consuming with hundreds of thousands of hills. In metadynminer you can use two functions for this purpose, <code>fes</code> and <code>fes2</code>. The former is fast and approximative, the latter is slow and more accurate. The function <code>fes</code> uses a pre-computed Gaussian hill which is simply being shifted on the canvas of the CV space for each hill and the bias potential is summed. The function <code>fes2</code> explicitly evaluates the Gaussian function. The function <code>fes</code> cannot be used in metadynamics with variable hills widths (the user would be warned).</p>
<p>In our tutorial we can do: </p><pre class="fragment">myfes12 &lt;- fes(myhills12)
</pre><p> (or the same with <code>fes2</code> for analyses, final illustations etc). Typing the name of the free energy surface variable <code>myfes12</code> returns the number of CVs, number of bins (by default 256 for one CV, and 256x256 for two CVs), free energy maximum and minimum.</p>
<p>It is possible to calculate the value of minimum and maximum of the free energy surface by functions <code>min</code> and <code>max</code>, respectively. You may add, subtract, multiply, and divide the free energy surface by a constant. For example, you can set the free energy minimum to zero by subtracting the minimum: </p><pre class="fragment">myfes12 &lt;- myfes12 - min(myfes12)
</pre><p> Similarly, to convert the free energy surface from kJ/mol to kcal/mol you may divide it by 4.18.</p>
<p>It is also possible to sum and subtract two free energy surfaces. This will be demonstrated later.</p>
<p>The important function of Metadynaminer is plotting of the free energy surface. You can use: </p><pre class="fragment">plot(myfes12)
</pre><p> Again, you may use options <code>xlim</code>, <code>ylim</code>, <code>zlim</code>, <code>main</code>, <code>sub</code>, <code>xlab</code>, <code>ylab</code>, <code>labcex</code> and <code>drawlabels</code> (see <code>?plot.fes</code>). You may control the type of the plot by the <code>plottype</code>. The option <code>plottype="image"</code> plots a heat map, <code>plottype="contour"</code> plots contours, and <code>plottype="both"</code> plots both.</p>
<p>It is possible to switch on the free energy scale by: </p><pre class="fragment">plot(myfes12, colscale=T)
</pre><p> You may change the title of the scale by <code>colscalelab="your label"</code>.</p>
<p>It is often necessary to control the levels of contours. For example, to plot the free energy surface with 20 contours by 10 kJ/mol type: </p><pre class="fragment">myfes12 &lt;- myfes12 - min(myfes12)
plot(myfes12, zlim=c(0,200), nlevels=20)
</pre><p> You may also explicitly set levels as a vector by the parameter <code>levels</code>.</p>
<p>The default color palette for a 2D free energy surface in Metadynminer is <code>rainbow(135)[100:1]</code> (i.e., rainbow without violet color). If you prefer your own color palette, you may set it as <code>col</code> paramtere. For example, this command plots the free energy surface in gray colors: </p><pre class="fragment">plot(myfes12, col=gray.colors(50))
</pre><p>Metadynminer can identify minima on the free energy surface. This can be done by the function: </p><pre class="fragment">myminima12 &lt;- fesminima(myfes12)
myminima12
</pre><p> The program should find approximately five free energy minima for alalnine dipeptide in water and print their idetifier (letters A, B, C, ... followed by AA, AB, AC, ...), location on the free energy surface (in bin ID and in CVs), and the free energy (for the final free energy surface). The function <code>summary</code> prints also populations (temperature and energy units can be controlled by <code>temp</code> and <code>eunit</code>, respectively).</p>
<p>Some metadynamics simulations may result in rough free energy surfaces with hundreds of free energy minima. It is not useful to identify all of them. It is better to find a reasonable number of minima scattered on the whole free energy surface. The function <code>fesminima</code> splits the canvas of the free energy surface into a certain number of sections (by default 8x8 for 2D and 8 for 1D free energy surfaces, it may be controled by <code>nbins</code>). A global minimum is found in each section and then it is checked whether it is a local minimum of the entire free energy surface. If not, it is discarded.</p>
<p>It may happen that the function <code>fesminima</code> cannot identify some minimum or it is necessary to add a reference point on a free energy surface, which is not a minimum. For this purpose, it is possible to make a minimum by <code>oneminimum</code> function and add it to the existing minima (by addition operation).</p>
<p>The output of <code>fesminima</code> can be plotted by <code>plot</code> function. The plot is similar to the free energy surface and it contains additional letters in the points of minima. </p><pre class="fragment">plot(myminima12)
</pre><p>Convergency of metadynamics can be assessed by the time profile of the differences between free energy minima. Stable difference between free energy minima indicates that the free energy surface is converged and thus accurate. It must be kept in mind that this is a necessary but not the only requirement of convergence. Please follow the <a href="https://www.plumed.org/doc-v2.7/user-doc/html/masterclass-21-2.html">PLUMED Masterclass 21.2: Statistical errors in MD</a> for more details. The time profile of the differences between free energy minima can be caluclated and plotted as: </p><pre class="fragment">myprof12 &lt;- feprof(myminima12)
plot(myprof12)
</pre><p> The program takes free energy minima (as identified by the function <code>fesminima</code>) and calculates the values of free energy in the same point in the CV space along the simulation. Typing the name of the time profile returns the same output as for minima. The function <code>summary</code> prints the same output as the summary of free energy minima together with minimal and maximal free energy relative to the global free energy minimum. The minimum A is always the global minimum and its relative free energy is 0 (also its minimum and maximum is zero). The column <code>tail</code> contains the relative free energy at the end of the simulation. It is possible to specify the time window in which the minimum and maximum are calculated, for example the second half of the simulation, by <code>imind</code> and <code>imaxd</code>. By default they are set to 1 and the number of hills, respectively, i.e. to whole simulation.</p>
<p>Finally, metadynminer provides a function for the nudged elastic band: </p><pre class="fragment">myneb&lt;-neb(myminima12, min1="A", min2="D")
myneb
plot(myneb)
plot(myminima12)
linesonfes(myneb)
</pre><h2><a class="anchor" id="masterclass-22-02-ex-2"></a>
Exercise 2: Making high resolution plots and movies</h2>
<p>In Rstudio it is possible to save plotted figures in different vector and bitmap formats and it is possible to customize their resolution. As an alternative, it is possible to save figures by the functions <code>png</code>, <code>bmp</code>, <code>jpeg</code>, <code>tiff</code>, <code>svg</code>, <code>pdf</code> or <code>eps</code>. These functions use the file name as an argument and it switches the plotting environment, so that the file is plotted into the file and not on the screen. This option must be switched off by the function <code>dev.off()</code>. These functions work in the basic R (i.e., without Rstudio) and can be used for example at high-performance computing clusters, grids, and clouds without GUI. Our suggestion to make a nice publication quality figure in the size of 8x8 cm (typical half page) is: </p><pre class="fragment">png("filename.png", height=8, width=8, units='cm', res=600, pointsize=6)
plot(myfes12)
dev.off()
</pre><p>The functions for image saving can be used with regular expressions. This is useful for making movies. A movie of free energy evolution can be simply made by: </p><pre class="fragment">tfes&lt;-fes(myhills12, imax=50)
png("snap%04d.png")
plot(tfes, zlim=c(-200,0))
for(i in 1:199) {
  tfes&lt;-tfes+fes(myhills12, imin=50*i+1, imax=50*(i+1))
  plot(tfes, zlim=c(-200,0))
}
dev.off()
</pre><p> Functions <code>imin</code> and <code>imax</code> make it possible to restrict the summation to certain hill range. The first line calculates the sum of the first 50 hills. The second call of the <code>fes</code> function calculates the sum of hills 51 to 100 and adds it to the total free energy surface. The resulting 200 files named <code>snap0001.png</code>, <code>snap0002.png</code>, etc can be concatenated to a movie by means of some movie editing software.</p>
<h2><a class="anchor" id="masterclass-22-02-ex-3"></a>
Exercise 3: Making a movie of flooding</h2>
<p>The first task in this tutorial is to calculate the free energy surface of alanine dipeptide calculated in the space of two collective variables phi and psi. This can be done by typing: </p><pre class="fragment">library(metadynminer)
myhills12 &lt;- read.hills("HILLS.cv12", per=c(T, T))
myfes12 &lt;- fes(myhills12)
plot(myfes12)
</pre><p>The 2D free energy surface can be converted to 1D by conversion of the free energy to probability, integration of probabilities along one CV and conversion back to free energy. In metadynminer you can do this by the function <code>fes2d21d</code>: </p><pre class="fragment">myfes12.1d &lt;- fes2d21d(myhills12, remdim=2)
</pre><p> The option <code>remdim</code> sets which CV should be removed (<code>remdim=2</code> removes psi). It is also possible to set the temperature and energy units by <code>temp</code> and <code>eunit</code>, respectively.</p>
<p>Now we will use this free energy surface (calculated from 10 ns metadynamics) as the "ground truth" and we will try how this free energy surface was flooded by 1 ns metadynamics with a single CV, either phi or psi.</p>
<p>Hills file from the other two simulations can be loaded by: </p><pre class="fragment">myhills1 &lt;- read.hills("HILLS.cv1", per=_FILL_)
myhills2 &lt;- read.hills("HILLS.cv2", per=_FILL_)
</pre><p> Replace <code>_FILL_</code> by the correct expression.</p>
<p>Next, for time 10 ps to 1 ns (hills 10 to 1000, with an increment of 10), calculate the free energy surface, convert it to a bias potential by multiplication by minus (biasfactor - 1)/biasfactor and add it to the ground truth free energy surface. The bias factor was 15 in this simulation. Plot the result (in black) together with the ground truth free energy surface in red: </p><pre class="fragment">myfes12.1d &lt;- myfes12.1d - min(myfes12.1d)
flooded &lt;- myfes12.1d
flooded$hills &lt;- c()
png("snap%04d.png")
plot(myfes12.1d, ylim=c(0,100), col="red")
for(i in _FILL_) {
  plot(myfes12.1d, ylim=c(0,100), col="red")
  myfes1 &lt;- fes(myhills1, imin=_FILL_, imax=_FILL_)
  flooded &lt;- flooded + _FILL_*myfes1
  lines(flooded)
}
dev.off()
</pre><p> Again, replace each <code>_FILL_</code> by a suitable expression. Keep in mind that it is possible to compose the plot from multiple plots. The function <code>plot</code> creates the first plot and functions <code>lines</code> or <code>points</code> add to this plot.</p>
<p>The meaning of the line <code>flooded$hills &lt;- c()</code> is following. Objects in R may contain different instances stored as <code>variable$instance</code> The object of the free energy surface contains the free energy surface, information about the axes and their periodicity and other information, but also the original hills from which the free energy surface was calculated. Something similar applies also to the object of free energy minima. The reason for this is that the function <code>feprof</code> needs hills data. Summation of free energy surfaces is equivalent to concatenation of hills, so the sum of two free energy surfaces contains concatenated hills as its <code>$hills</code> instance. However, in the line <code>flooded &lt;- flooded + _FILL_*myfes1</code> it is not possible to concatenate 1D and 2D hills. For this reason we erased hills from the variable <code>flooded</code>.</p>
<p>If possible, make a movie or visually inspect the resulting files. Evaluate the flooding by the 1D potential in terms of convergence.</p>
<h2><a class="anchor" id="masterclass-22-02-ex-4"></a>
Exercise 4: Reweighing</h2>
<p>It would be also interesting to see the performance of metadynamics with psi torsion as the only CV. Unfortunately, it is not possible to calculate the free energy surface in the space of phi torsion from this simulation simply by summing hills. This can be done by reweighing. This will also demonstrate the advanced features of metadynminer.</p>
<p>Reweighing predicts what would have been the distribution of a CV or CVs in the biased simulation, if it had not been biased. <a href="https://doi.org/10.1016%2F0021-9991%2877%2990121-8">Umbrella sampling reweighing</a> weights the distribution of the states by exp(+bias/kT). This can be applied to metadynamics bias potential with a correction to the time-dependence of the bias potential. We will use the correction introduced by <a href="https://doi.org/10.1021/jp504920s">Tiwari and Parrinello</a>. The main idea is the bias potential is divided into time-independent and the time-dependent component. The time-dependent component is calculated by the following procedure: </p><pre class="fragment">library(metadynminer)
bf &lt;- 15
nframes &lt;- 50
temp &lt;- 300
myhills2 &lt;- read.hills("HILLS.cv2", per=c(T))
s1&lt;-rep(0, nframes)
s2&lt;-rep(0, nframes)
for(i in 1:nframes) {
  step &lt;- i*length(myhills2$time)/nframes
  onefes &lt;- fes(myhills2, imax=step)
  s1[i] &lt;- sum(exp(-1000*onefes$fes/8.314/temp))
  s2[i] &lt;- sum(exp(-1000*onefes$fes/8.314/temp/bf))
}
ebetac &lt;- s1/s2
</pre><p> The variable <code>bf</code> contains the bias factor. The R function <code>rep</code> generates a vector by repeating an element. Here it generates a vector with <code>nframes</code> (50) elements equal to zero. The variable <code>step</code> is equal to the number of hills divided by 50 in the first step, twice as many in the second step, etc. The free energy surface is calculated for this number of hills. Next, exp(-G/kT) and exp(-G/kDeltaT) is calculated and stored in vectors <code>s1</code> and <code>s2</code>, respectively. Finally, <code>s1</code> and <code>s2</code> are divided elementwise and stored to <code>ebetac</code>.</p>
<p>Next, we open the colvar file and calculate the probabilities of the phi torsion. This can be done by: </p><pre class="fragment">mycolvar2 &lt;- read.table("COLVAR.cv2")
cv1 &lt;- floor(32*(mycolvar2[,2]+pi)/pi) + 1
bias &lt;- 1000*mycolvar2[,4]
probs &lt;- rep(0, 64)
for(i in 1:nrow(mycolvar2)) {
  step &lt;- (i-1)*nframes/nrow(mycolvar2)+1
  probs[cv1[i]] &lt;- probs[cv1[i]] + exp(bias[i]/temp/8.314)/ebetac[step]
}
fes &lt;- -8.314*temp*log(probs)/1000
fes &lt;- fes - min(fes)
fes[fes&gt;100] &lt;- 100 
myfes &lt;- fes(myhills2, npoints=64, imax=1)
myfes$fes &lt;- fes
plot(myfes, ylim=c(0,60))
</pre><p> The function <code>read.table</code> is a standard function of R for reading tabular data. The first CV is extracted from the table and converted to bin number (with 64 bins). Next, the probability vector <code>prob</code> is generated. The program then runs across all lines of the colvar file and adds <code>exp(bias[i]/temp/8.314)/ebetac[step]</code> to the probability in the bin of phi angle in i-th line. The resulting probabilities are converted to free energy and the free energy of unsampled bins is converted to 100 kJ/mol (instead of infinity, for better handling). Finally, a free energy surface with 64 bins is calculated from the first hill and the free energy surface object is replaced by our <code>fes</code>. This free energy surface is plotted. Compare free energy surfaces calculated with phi CV and psi CV. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
