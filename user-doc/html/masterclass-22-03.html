<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: PLUMED Masterclass 22.3: OPES method</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.9.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('masterclass-22-03.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">PLUMED Masterclass 22.3: OPES method </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section author"><dt>Authors</dt><dd>Michele Invernizzi </dd></dl>
<dl class="section date"><dt>Date</dt><dd>February 28, 2022</dd></dl>
<h1><a class="anchor" id="masterclass-22-03-aims"></a>
Aims</h1>
<p>This Masterclass is an introduction to the <a class="el" href="_o_p_e_s.html">OPES (On-the-fly Probability Enhanced Sampling)</a> method and its PLUMED implementation.</p>
<h1><a class="anchor" id="masterclass-22-03-obj"></a>
Objectives</h1>
<p>Once this Masterclass is completed, you will be able to:</p>
<ul>
<li>Perform OPES simulations and analyse the results.</li>
<li>Use <a class="el" href="_o_p_e_s__e_x_p_a_n_d_e_d.html">OPES_EXPANDED</a> to sample different generalized ensembles</li>
<li>Test the effect of various <a class="el" href="_o_p_e_s__m_e_t_a_d.html">OPES_METAD</a> input options</li>
<li>Understand the typical use-case for <a class="el" href="_o_p_e_s__m_e_t_a_d__e_x_p_l_o_r_e.html">OPES_METAD_EXPLORE</a></li>
</ul>
<h1><a class="anchor" id="masterclass-22-03-prereq"></a>
Prerequisites</h1>
<p>We assume that you are familiar with PLUMED, metadynamics, umbrella sampling, and replica exchange. If you are not, the 2021 PLUMED Masterclass is a great place to start. In particular we suggest <a class="el" href="masterclass-21-1.html">PLUMED Masterclass 21.1: PLUMED syntax and analysis</a>, <a class="el" href="masterclass-21-3.html">PLUMED Masterclass 21.3: Umbrella sampling</a>, and <a class="el" href="masterclass-21-4.html">PLUMED Masterclass 21.4: Metadynamics</a>. Reading the OPES papers is also recommended <a class="el" href="citelist.html#CITEREF_Invernizzi2020rethinking">[73]</a> <a class="el" href="citelist.html#CITEREF_Invernizzi2022explore">[74]</a> <a class="el" href="citelist.html#CITEREF_Invernizzi2020unified">[75]</a>.</p>
<h1><a class="anchor" id="masterclass-22-03-theory"></a>
Overview of the theory</h1>
<p>The OPES method is an evolution of Metadynamics that also incorporates some of the ideas of the <a class="el" href="_v_e_s.html">Variationally Enhanced Sampling (VES code)</a> method. OPES is designed to be simple to use and robust with respect to suboptimal collective variables. Compared to metadynamics, it is faster in converging to a quasi-static bias and it handles multi-dimensional collective variables more efficiently.</p>
<p>The theory for the OPES method is presented in three separate papers <a class="el" href="citelist.html#CITEREF_Invernizzi2020rethinking">[73]</a> <a class="el" href="citelist.html#CITEREF_Invernizzi2022explore">[74]</a> <a class="el" href="citelist.html#CITEREF_Invernizzi2020unified">[75]</a>. A short overview can be found in the PLUMED documentation at <a class="el" href="_o_p_e_s.html">OPES (On-the-fly Probability Enhanced Sampling)</a>, <a class="el" href="_o_p_e_s__e_x_p_a_n_d_e_d.html">OPES_EXPANDED</a>, <a class="el" href="_o_p_e_s__m_e_t_a_d.html">OPES_METAD</a>, and <a class="el" href="_o_p_e_s__m_e_t_a_d__e_x_p_l_o_r_e.html">OPES_METAD_EXPLORE</a>.</p>
<p> <details> <summary> <b> To learn more: Introduction to the theory </b> </summary> <div class="hidden"> </p>
<p>The OPES method aims at sampling a given target distribution over the configuration space, \(p^{\text{tg}}(\mathbf{x})\), different from the equilibrium Boltzmann distribution, \(P(\mathbf{x})\propto e^{-\beta U(\mathbf{x})}\). To do so, it iteratively builds a bias potential \(V(\mathbf{x})\), by estimating on-the-fly the needed probability distributions: </p><p class="formulaDsp">
\[ V(\mathbf{x}) = -\frac{1}{\beta}\log\frac{p^{\text{tg}}(\mathbf{x})}{P(\mathbf{x})}\, . \]
</p>
<p> The bias quickly becomes quasi-static and the desired properties, such as the free energy, can be calculated with a simple reweighting. For any given observable \(O=O(\mathbf{x})\) one can write the expectation value as: </p><p class="formulaDsp">
\[ \langle O \rangle_{P} = \frac{\langle O e^{\beta V}\rangle_{p^{\text{tg}}}}{\langle e^{\beta V}\rangle_{p^{\text{tg}}}}\, . \]
</p>
<p>There are two ways to define an OPES target distribution, a metadynamics-like and a replica-exchange-like. A replica-exchange-like target distribution is an expanded ensemble defined as a sum of overlapping probability distributions: </p><p class="formulaDsp">
\[ p^{\text{tg}}_{\{\lambda\}}(\mathbf{x})=\frac{1}{N_{\{\lambda\}}}\sum_{\lambda} P_{\lambda}(\mathbf{x})\, . \]
</p>
<p> A typical example is the temperature expanded ensemble, where each \( P_{\lambda}(\mathbf{x})\) is the same system, but at a different temperature. This kind of target distribution can be defined via a set of expansion collective variables (ECVs). The action <a class="el" href="_o_p_e_s__e_x_p_a_n_d_e_d.html">OPES_EXPANDED</a> can be used to sample this kind of target distributions.</p>
<p>A metadynamics-like target distribution, is defined by its marginal over a set of collective variables (CVs), \(\mathbf{s}=\mathbf{s}(\mathbf{x})\). A typical choice for this marginal distribution is the well-tempered one: </p><p class="formulaDsp">
\[ p^{\text{WT}}(\mathbf{s})=\left[P(\mathbf{s})\right]^{1/\gamma}\, , \]
</p>
<p> where \(P(\mathbf{s})\) is the marginal over the CVs of the Boltzmann distribution, and \(\gamma&gt;1\) is the bias factor. The well-tempered distribution is a smoother version of the original one, and in the limit of \(\gamma=\infty\) it become a uniform distribution. The actions <a class="el" href="_o_p_e_s__m_e_t_a_d.html">OPES_METAD</a> and <a class="el" href="_o_p_e_s__m_e_t_a_d__e_x_p_l_o_r_e.html">OPES_METAD_EXPLORE</a> can be used to sample this kind of target distributions.</p>
<p> </div> </details> </p>
<h1><a class="anchor" id="masterclass-22-03-install"></a>
Setting up the software</h1>
<p>For this Masterclass we will use GROMACS 2020.6 patched with PLUMED 2.8, with the OPES module and MPI enabled. The easiest way to install all the software needed is to use the <code>plumed-masterclass-2022</code> conda environment, as described <a href="https://github.com/plumed/masterclass-2022">here</a>.</p>
<h1><a class="anchor" id="masterclass-22-03-resources"></a>
Resources</h1>
<p>The data needed to complete the exercises of this Masterclass can be found on <a href="https://github.com/invemichele/masterclass-22-03">GitHub</a>. You can clone this repository locally on your machine with the usual command:</p>
<pre class="fragment">git clone https://github.com/invemichele/masterclass-22-03.git
</pre><p>The repository contains all the data to run the simulations, together with the scripts to analyse them. It also contains some annotated <a href="https://github.com/invemichele/masterclass-22-03/tree/master/notebooks">Jupyter notebooks</a>, that will guide us through this tutorial. Most of the information can be found there, and this page is mainly meant as an overview of the content of the notebooks.</p>
<p>As done in some previous masterclass, we will play with a toy system, the small alanine dipeptide molecule in vacuum (ala2). It has the advantage of being a well-known system, cheap to simulate and with a higher level of complexity compared to a 2D model potential as the one used in this other <a class="el" href="opes-metad.html">OPES_METAD Tutorial: Running and post-processing</a>. Ala2 has two main metastable basins which can be identified by a very efficient collective variable (CV), the \(\phi\) torsional angle. Here is its free energy surface (FES) as a function of the \(\phi\) and \(\psi\) angles:</p>
<div class="image">
<img src="masterclass-22-03-ala2_FES.png" alt=""/>
<div class="caption">
Alanine dipeptide free energy surface along the Ramachandran angles.</div></div>
<dl class="section note"><dt>Note</dt><dd>All the exercises have been tested with PLUMED version 2.8.0 and GROMACS 2020.6</dd></dl>
<h1><a class="anchor" id="masterclass-22-03-ex-1"></a>
Exercise 1: Sampling expanded ensembles with OPES</h1>
<p>We start by using OPES to sample expanded ensembles <a class="el" href="citelist.html#CITEREF_Invernizzi2020unified">[75]</a>. This probably is not a familiar application of adaptive-bias enhanced sampling for most of PLUMED users, so we will start with a little</p>
<h2><a class="anchor" id="masterclass-22-03-ex-1-1"></a>
1.1 Multithermal simulations</h2>
<p>The first example we consider is a multithermal simulation of alanine dipeptide. One can use replica exchange to perform a parallel tempering simulation and sample the two metastable states of alanine dipeptide, as explained for instance in <a class="el" href="belfast-7.html">Belfast tutorial: Replica exchange I</a>. Here instead, we want to sample the same multithermal distribution not by combining simulations at different temperatures, but by adding a bias potential to a single simulation.</p>
<p> <details> <summary> <b> To learn more: The bias that we need </b> </summary> <div class="hidden"> </p>
<p>We choose 3 temperatures \(T_0, T_1, T_2\), ranging from 300 K to 1000 K, and setup our GROMACS simulation to run at \(T_0=300\) K. Our target distribution is then: </p><p class="formulaDsp">
\[ p^{\text{tg}}(\mathbf{x})=\frac{1}{3}\left[\frac{e^{-\frac{1}{k_BT_0}U(\mathbf{x})}}{Z_0}+ \frac{e^{-\frac{1}{k_BT_1}U(\mathbf{x})}}{Z_1}+\frac{e^{-\frac{1}{k_BT_2}U(\mathbf{x})}}{Z_2}\right] \]
</p>
<p> This can be rewritten highlighting \(P(\mathbf{x})\) </p><p class="formulaDsp">
\[ p^{\text{tg}}(\mathbf{x})=P(\mathbf{x})\frac{1}{3}\left[1+ e^{-\left(\frac{1}{k_BT_1}-\frac{1}{k_BT_0}\right)U(\mathbf{x})}\frac{Z_0}{Z_1}+e^{-\left(\frac{1}{k_BT_2}-\frac{1}{k_BT_0}\right)U(\mathbf{x})}\frac{Z_0}{Z_2}\right] \]
</p>
<p> and then using \(\Delta F_i = -k_B T_0 \log \frac{Z_i}{Z_0}\): </p><p class="formulaDsp">
\[ p^{\text{tg}}(\mathbf{x})=P(\mathbf{x})\frac{1}{3}\left[1+ e^{-\frac{1-T_0/T_1}{k_BT_0}U(\mathbf{x})+\frac{1}{k_BT_0}\Delta F_1}+e^{-\frac{1-T_0/T_2}{k_BT_0}U(\mathbf{x})+\frac{1}{k_BT_0}\Delta F_2}\right] \]
</p>
<p> so we just need to know \(\Delta F_1\) and \(\Delta F_2\), and we can sample the target multithermal distribution by using the following bias: </p><p class="formulaDsp">
\[ V(U) = - k_B T_0 \log \frac{1}{3}\left[1+ e^{-\frac{1-T_0/T_1}{k_BT_0}U(\mathbf{x})+\frac{1}{k_BT_0}\Delta F_1}+e^{-\frac{1-T_0/T_2}{k_BT_0}U(\mathbf{x})+\frac{1}{k_BT_0}\Delta F_2}\right] \]
</p>
<p> that is a function only of the potential energy \(U=U(\mathbf{x})\). In the OPES spirit, we estimate on-the-fly these free energy differences using a simple reweighting, and iteratively reach the target distribution.</p>
<p>The final bias expression is determined by these quantities \(\frac{1-T_0/T_i}{k_BT_0}U(\mathbf{x})\), that we call expansion_cv (ECVs). There are several types of expanded ensembles that might be of interest, and in order to sample them with OPES one simply needs to find the explicit form of the corresponding ECVs. To sample the same expanded ensemble with replica exchange, one has to run a different replica of the system for each of the ECVs.</p>
<p> </div> </details> </p>
<p>Enough equations, here is the plumed input file we need to run this multithermal simulation:</p>

<div style="width: 90%; float:left" id="value_details_eg1"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-passing-green.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<b name="eg1ene" onclick='showPath("eg1","eg1ene")'>ene: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_e_n_e_r_g_y.html" style="color:green">ENERGY</a> <span style="display:none;" id="eg1ene">The ENERGY action with label <b>ene</b> calculates a single scalar value</span>
<b name="eg1ecv" onclick='showPath("eg1","eg1ecv")'>ecv: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_e_c_v__m_u_l_t_i_t_h_e_r_m_a_l.html" style="color:green">ECV_MULTITHERMAL</a> <div class="tooltip">ARG<div class="right"><b>compulsory keyword </b>
the label of the internal energy of the system. <i></i></div></div>=<b name="eg1ene">ene</b> <div class="tooltip">TEMP_MIN<div class="right">the minimum of the temperature range <i></i></div></div>=300 <div class="tooltip">TEMP_MAX<div class="right">the maximum of the temperature range <i></i></div></div>=1000 <div class="tooltip">TEMP_STEPS<div class="right">the number of steps in temperature <i></i></div></div>=3 <span style="display:none;" id="eg1ecv">The ECV_MULTITHERMAL action with label <b>ecv</b> calculates a single scalar value</span>
<b name="eg1opes" onclick='showPath("eg1","eg1opes")'>opes: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_o_p_e_s__e_x_p_a_n_d_e_d.html" style="color:green">OPES_EXPANDED</a> <div class="tooltip">ARG<div class="right"><b>compulsory keyword </b>
the label of the ECVs that define the expansion. <i></i></div></div>=<b name="eg1ecv">ecv.ene</b> <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
how often the bias is updated <i></i></div></div>=500 <span style="display:none;" id="eg1opes">The OPES_EXPANDED action with label <b>opes</b> calculates a single scalar value</span>
</pre>
<p>We use the <a class="el" href="_o_p_e_s__e_x_p_a_n_d_e_d.html">OPES_EXPANDED</a> bias action, with a multithermal expansion defined by the <a class="el" href="_e_c_v__m_u_l_t_i_t_h_e_r_m_a_l.html">ECV_MULTITHERMAL</a> action. The resulting bias is a function of the potential energy, and is updated every 500 MD steps.</p>
<p>In the notebook we show the shape of the resulting bias, how to check for convergence and how to reweight for estimating the free energy at different temperatures. We also explain a simple procedure that is used to automatically set a reasonable number of temperature steps, if TEMP_STEPS is not provided.</p>
<h2><a class="anchor" id="masterclass-22-03-ex-1-2"></a>
1.2 Multiumbrella simulations</h2>
<p>Next, we present another expanded ensemble that can also be sampled by replica exchange. We call it multiumbrella and it is composed by all the distributions sampled by a typical multiple windows umbrella sampling simulation. In this kind of umbrella sampling, one chooses a CV and runs several simulations each one with a parabolic bias potential at a different CV location (see <a class="el" href="masterclass-21-3.html">PLUMED Masterclass 21.3: Umbrella sampling</a>). We can use OPES to sample an expanded target distribution that is composed of all of these combined.</p>
<p>In multiple windows umbrella sampling, the free energy difference between the windows is estimated during postprocessing (e.g. with WHAM), in OPES this is done on-the-fly at simulation time. The main advantages are that choosing the number and location of the umbrellas becomes easier, and having a single longer simulation can also help with sampling orthogonal slow degrees of freedom.</p>
<p>We choose as CV the \(\phi\) angle. The ECVs we need for this type of expansion are the following: </p><p class="formulaDsp">
\[ \Delta u_i = \frac{(\phi-\phi_i)^2}{2\sigma^2}\, , \]
</p>
<p> where \(\phi_i\) are the fixed centers of the umbrellas and \(\sigma\) determines their width. Usually in umbrella sampling another parameter is used, \(k=1/\sqrt{\sigma}\), but we will see in the notebook why we made a different choice.</p>
<p>The plumed input we need might look like this:</p>

<div style="width: 90%; float:left" id="value_details_eg2"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-passing-green.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<b name="eg2phi" onclick='showPath("eg2","eg2phi")'>phi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=5,7,9,15 <span style="display:none;" id="eg2phi">The TORSION action with label <b>phi</b> calculates a single scalar value</span>
<b name="eg2ecv" onclick='showPath("eg2","eg2ecv")'>ecv: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_e_c_v__u_m_b_r_e_l_l_a_s__l_i_n_e.html" style="color:green">ECV_UMBRELLAS_LINE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg2phi">phi</b> <div class="tooltip">CV_MIN<div class="right"><b>compulsory keyword </b>
the minimum of the CV range to be explored <i></i></div></div>=-pi <div class="tooltip">CV_MAX<div class="right"><b>compulsory keyword </b>
the maximum of the CV range to be explored <i></i></div></div>=pi <div class="tooltip">SIGMA<div class="right"><b>compulsory keyword </b>
sigma of the umbrella Gaussians <i></i></div></div>=0.2 <span style="display:none;" id="eg2ecv">The ECV_UMBRELLAS_LINE action with label <b>ecv</b> calculates a single scalar value</span>
<b name="eg2opes" onclick='showPath("eg2","eg2opes")'>opes: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_o_p_e_s__e_x_p_a_n_d_e_d.html" style="color:green">OPES_EXPANDED</a> <div class="tooltip">ARG<div class="right"><b>compulsory keyword </b>
the label of the ECVs that define the expansion. <i></i></div></div>=<b name="eg2ecv">ecv.phi</b> <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
how often the bias is updated <i></i></div></div>=500 <span style="display:none;" id="eg2opes">The OPES_EXPANDED action with label <b>opes</b> calculates a single scalar value</span>
</pre>
<p>This places umbrellas uniformly along \(\phi\), each one separated by a distance of one \(\sigma\). We can make them less close to each with the keyword SPACING. We can also provide a guess of the maximum free energy BARRIER we need to overcome, it can help speed up convergence.</p>
<p>In the notebook we show what kind of sampling this input provides, and invite you to play around with the parameters, to get a sense of what each option does. We also perform reweighting to obtain a FES estimate. This reweighting is done with kernel density estimation (similarly to plumed histogram function), and is interesting to see the effect of changing the bandwidth parameter.</p>
<h2><a class="anchor" id="masterclass-22-03-ex-1-3"></a>
1.3 Combined multithermal and multiumbrella simulations</h2>
<p>Another advantage of using OPES to sample expanded ensembles is that it makes it very easy to combine them. We show this by running a combined multithermal and multiumbrella simulation of alanine dipeptide.</p>
<p>Using the multithermal expansion, we were able to sample both metastable states, but not very efficiently. With the multiumbrella target distribution we have many transitions, but we sample only at 300 K. By combining these two expansions we obtain the best of both, with frequent transitions and an efficient reweighting over a whole range of temperatures.</p>
<p>The drawback? We might have to deal with a lot of ECVs! However, while in a replica exchange scheme each ECV requires its own replica, with OPES we are free to use just one, or choose any number of parallel replica, in a multiple walkers scheme.</p>
<p>The way we combine expansions is to create a grid with all possible combinations of temperature ECVs and umbrella ECVs. So, if we have 10 ECVs for the temperature expansion and 20 for the multiumbrella one, we end up with 200 combined ECVs. This will become clearer once we look at the notebook and the simulation output.</p>
<p>From the point of view of the plumed input things are quite straightforward. For a combined multithermal-multiumbrella simulation it should look similar to this one:</p>

<div style="width: 90%; float:left" id="value_details_eg3"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-passing-green.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># temperature expansion, based on energy</span>
<b name="eg3ene" onclick='showPath("eg3","eg3ene")'>ene: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_e_n_e_r_g_y.html" style="color:green">ENERGY</a> <span style="display:none;" id="eg3ene">The ENERGY action with label <b>ene</b> calculates a single scalar value</span>
<b name="eg3ecv_mt" onclick='showPath("eg3","eg3ecv_mt")'>ecv_mt: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_e_c_v__m_u_l_t_i_t_h_e_r_m_a_l.html" style="color:green">ECV_MULTITHERMAL</a> <div class="tooltip">ARG<div class="right"><b>compulsory keyword </b>
the label of the internal energy of the system. <i></i></div></div>=<b name="eg3ene">ene</b> <div class="tooltip">TEMP_MIN<div class="right">the minimum of the temperature range <i></i></div></div>=300 <div class="tooltip">TEMP_MAX<div class="right">the maximum of the temperature range <i></i></div></div>=1000 <span style="display:none;" id="eg3ecv_mt">The ECV_MULTITHERMAL action with label <b>ecv_mt</b> calculates a single scalar value</span>
<span style="color:blue"># multiumbrella expansion, based on phi</span>
<b name="eg3phi" onclick='showPath("eg3","eg3phi")'>phi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=5,7,9,15 <span style="display:none;" id="eg3phi">The TORSION action with label <b>phi</b> calculates a single scalar value</span>
<b name="eg3ecv_mu" onclick='showPath("eg3","eg3ecv_mu")'>ecv_mu: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_e_c_v__u_m_b_r_e_l_l_a_s__l_i_n_e.html" style="color:green">ECV_UMBRELLAS_LINE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg3phi">phi</b> <div class="tooltip">CV_MIN<div class="right"><b>compulsory keyword </b>
the minimum of the CV range to be explored <i></i></div></div>=-pi <div class="tooltip">CV_MAX<div class="right"><b>compulsory keyword </b>
the maximum of the CV range to be explored <i></i></div></div>=pi <div class="tooltip">SIGMA<div class="right"><b>compulsory keyword </b>
sigma of the umbrella Gaussians <i></i></div></div>=0.2 <span style="display:none;" id="eg3ecv_mu">The ECV_UMBRELLAS_LINE action with label <b>ecv_mu</b> calculates a single scalar value</span>
<span style="color:blue"># the OPES bias combines them</span>
<b name="eg3opes" onclick='showPath("eg3","eg3opes")'>opes: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_o_p_e_s__e_x_p_a_n_d_e_d.html" style="color:green">OPES_EXPANDED</a> <div class="tooltip">ARG<div class="right"><b>compulsory keyword </b>
the label of the ECVs that define the expansion. <i></i></div></div>=<b name="eg3ecv_mt">ecv_mt.ene</b>,<b name="eg3ecv_mu">ecv_mu.phi</b> <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
how often the bias is updated <i></i></div></div>=500 <span style="display:none;" id="eg3opes">The OPES_EXPANDED action with label <b>opes</b> calculates a single scalar value</span>
</pre>
<p>To fully appreciate the strength of combining these two different expansions, one can run the same simulations but using the \(\psi\) angle instead of \(\phi\), and see what happens.</p>
<h1><a class="anchor" id="masterclass-22-03-ex-2"></a>
Exercise 2: OPES for metadynamics-like simulations</h1>
<p>We now use OPES to perform biased simulations very similar to those of metadynamics <a class="el" href="citelist.html#CITEREF_Invernizzi2020rethinking">[73]</a> <a class="el" href="citelist.html#CITEREF_Invernizzi2022explore">[74]</a>. We will sample a well-tempered distribution along a chosen set of collective variables.</p>
<h2><a class="anchor" id="masterclass-22-03-ex-2-1"></a>
2.1 Biasing a good CV</h2>
<p>We start by biasing the \(\phi\) angle, which is known to be a good CV for alanine dipeptide. Here is how the FES along this CV looks like:</p>
<div class="image">
<img src="masterclass-22-03-ala2_FESphi.png" alt=""/>
<div class="caption">
Alanine dipeptide free energy surface along one of its torsional angles.</div></div>
<p>We use this simple example to get familiar with <a class="el" href="_o_p_e_s__m_e_t_a_d.html">OPES_METAD</a>, its input parameter and output quantities. We also compare it with well-tempered metadynamics, and we start to see how this two methods differ.</p>
<p>This also gives us the opportunity of using some of the postprocessing scripts for OPES. For OPES, there is not yet a tool similar to the <a class="el" href="sum_hills.html">sum_hills</a>, but we can obtain the same result with simple python scripts and by dumping the state of the simulation through the STATE_WFILE keyword. This STATE file contains the compressed kernels used by OPES at a given time to represent the probability distribution, and thus the bias.</p>
<h2><a class="anchor" id="masterclass-22-03-ex-2-2"></a>
2.2 Biasing two good CVs</h2>
<p>Next, we move to biasing both the Ramachandran angles of ala2. A minimal plumed input to do this is the following:</p>

<div style="width: 90%; float:left" id="value_details_eg4"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-passing-green.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<b name="eg4phi" onclick='showPath("eg4","eg4phi")'>phi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=5,7,9,15 <span style="display:none;" id="eg4phi">The TORSION action with label <b>phi</b> calculates a single scalar value</span>
<b name="eg4psi" onclick='showPath("eg4","eg4psi")'>psi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=7,9,15,17 <span style="display:none;" id="eg4psi">The TORSION action with label <b>psi</b> calculates a single scalar value</span>
<b name="eg4opes" onclick='showPath("eg4","eg4opes")'>opes: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_o_p_e_s__m_e_t_a_d.html" style="color:green">OPES_METAD</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg4phi">phi</b>,<b name="eg4psi">psi</b> <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
the frequency for kernel deposition <i></i></div></div>=500 <div class="tooltip">BARRIER<div class="right"><b>compulsory keyword </b>
the free energy barrier to be overcome. <i></i></div></div>=40 <span style="display:none;" id="eg4opes">The OPES_METAD action with label <b>opes</b> calculates the following quantities:
<table  align="center" frame="void" width="95%%" cellpadding="5%%">
<tr><td width="5%%"><b> Quantity </b>  </td><td><b> Description </b> </td></tr>
<tr><td width="5%%">opes.bias</td><td>the instantaneous value of the bias potential</td></tr>
<tr><td width="5%%">opes.rct</td><td>estimate of c(t). \f$\frac{1}{\beta}\log \langle e^{\beta V} \rangle\f$, should become flat as the simulation converges. Do NOT use for reweighting</td></tr>
<tr><td width="5%%">opes.zed</td><td>estimate of Z_n. should become flat once no new CV-space region is explored</td></tr>
<tr><td width="5%%">opes.neff</td><td>effective sample size</td></tr>
<tr><td width="5%%">opes.nker</td><td>total number of compressed kernels used to represent the bias</td></tr>
</table>
</span>
</pre>
<p>This example gives us a nice opportunity to visualize the kernel compression algorithm in action. We can also get an idea of the differences between <a class="el" href="_o_p_e_s__m_e_t_a_d.html">OPES_METAD</a> and <a class="el" href="_o_p_e_s__m_e_t_a_d__e_x_p_l_o_r_e.html">OPES_METAD_EXPLORE</a> methods. The plumed inputs are identical:</p>

<div style="width: 90%; float:left" id="value_details_eg5"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-passing-green.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<b name="eg5phi" onclick='showPath("eg5","eg5phi")'>phi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=5,7,9,15 <span style="display:none;" id="eg5phi">The TORSION action with label <b>phi</b> calculates a single scalar value</span>
<b name="eg5psi" onclick='showPath("eg5","eg5psi")'>psi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=7,9,15,17 <span style="display:none;" id="eg5psi">The TORSION action with label <b>psi</b> calculates a single scalar value</span>
<b name="eg5opes" onclick='showPath("eg5","eg5opes")'>opes: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_o_p_e_s__m_e_t_a_d__e_x_p_l_o_r_e.html" style="color:green">OPES_METAD_EXPLORE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg5phi">phi</b>,<b name="eg5psi">psi</b> <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
the frequency for kernel deposition <i></i></div></div>=500 <div class="tooltip">BARRIER<div class="right"><b>compulsory keyword </b>
the free energy barrier to be overcome. <i></i></div></div>=40 <span style="display:none;" id="eg5opes">The OPES_METAD_EXPLORE action with label <b>opes</b> calculates the following quantities:
<table  align="center" frame="void" width="95%%" cellpadding="5%%">
<tr><td width="5%%"><b> Quantity </b>  </td><td><b> Description </b> </td></tr>
<tr><td width="5%%">opes.bias</td><td>the instantaneous value of the bias potential</td></tr>
<tr><td width="5%%">opes.rct</td><td>estimate of c(t). \f$\frac{1}{\beta}\log \langle e^{\beta V} \rangle\f$, should become flat as the simulation converges. Do NOT use for reweighting</td></tr>
<tr><td width="5%%">opes.zed</td><td>estimate of Z_n. should become flat once no new CV-space region is explored</td></tr>
<tr><td width="5%%">opes.neff</td><td>effective sample size</td></tr>
<tr><td width="5%%">opes.nker</td><td>total number of compressed kernels used to represent the bias</td></tr>
</table>
</span>
</pre>
<p>From here it should be easy to compare both OPES variants to metadynamics, maybe by running some longer simulations. We can also check the way the bias converges by focusing on the estimate of the free energy difference between the basins.</p>
<h2><a class="anchor" id="masterclass-22-03-ex-2-3"></a>
2.3 Biasing more CVs: alanine tetrapeptide</h2>
<p>In order to experiment with more than two CVs, we have to introduce a new system, alanine tetrapeptide in vacuum (ala4). It is a bigger brother of ala2, with not one but three \(\phi\) and \(\psi\) torsional angles, that can be used to sample its 8 metastable basins.</p>
<p>We can try to sample ala4 with each of the tree methods, <a class="el" href="_m_e_t_a_d.html">METAD</a>, <a class="el" href="_o_p_e_s__m_e_t_a_d.html">OPES_METAD</a>, and <a class="el" href="_o_p_e_s__m_e_t_a_d__e_x_p_l_o_r_e.html">OPES_METAD_EXPLORE</a>. How will the respective input files look like?</p>
<p>We run only short simulations to see how quickly the CV space is sampled by the various methods, and not for converging a FES. This example can help to appreciate the effect of the \(Z\) term in <a class="el" href="_o_p_e_s__m_e_t_a_d.html">OPES_METAD</a>. In fact, the more CVs there are, the more it plays an important role in speeding up exploration.</p>
<p>We can also see the effect of changing the bias factor \(\gamma\) on the sampling efficiency.</p>
<h2><a class="anchor" id="masterclass-22-03-ex-2-4"></a>
2.4 Biasing a suboptimal CV</h2>
<p>Finally, what is probably the most interesting scenario. We bias again ala2, but this time using a suboptimal collective variable. We don't know much about this CV, it could be for instance the output of a machine learning procedure. Will we be able to calculate the FES as a function of this CV? How should the plumed input files look like? Here it would be nice to also have some error bars to our estimates.</p>
<p>We will discuss together the results of these simulations, and also reveal how this CV was constructed.</p>
<p>If you prefer a more straightforward example of suboptimal CV, you can check out this <a class="el" href="opes-metad.html">OPES_METAD Tutorial: Running and post-processing</a>.</p>
<h1><a class="anchor" id="masterclass-22-03-con"></a>
Conclusion</h1>
<p>Hopefully this masterclass helped you to start playing around with the OPES method and get a sense of what it can be useful for. If you are still interested in testing it out and understanding more about it, then you should check out the <a href="https://www.plumed-nest.org/browse.html">PLUMED-NEST</a>. Just search for "opes" and you will find several papers that use the method, together with all the input files necessary to reproduce their simulations. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
