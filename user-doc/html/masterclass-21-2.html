<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: PLUMED Masterclass 21.2: Statistical errors in MD</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.9.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('masterclass-21-2.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">PLUMED Masterclass 21.2: Statistical errors in MD </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="masterclass-21-2-aims"></a>
Aims</h1>
<p>In this Masterclass, we will discuss how to report the results from molecular simulations. <br  />
 We will emphasize that any result that we get from any simulation is a random variable. To make the result reproducible, we must characterize the distribution that has been sampled. It is not sufficient to report the averages.</p>
<h1><a class="anchor" id="masterclass-21-2-lo"></a>
Objectives</h1>
<p>Once you have completed this Masterclass you will be able to:</p>
<ul>
<li>Use PLUMED to calculate time averages and histograms from biased and unbiased simulation data.</li>
<li>Use PLUMED to perform block averaging.</li>
<li>Calculate error bars on-time averages computed form biased and unbiased simulation data using the central limit theorem and non-parametric bootstrap.</li>
</ul>
<h1><a class="anchor" id="masterclass-21-2-install"></a>
Setting up PLUMED</h1>
<p>If you have not yet set up PLUMED, you can find information about installing it in the section <a class="el" href="masterclass-21-1.html#masterclass-21-1-install">Setting up the software</a> of <a class="el" href="masterclass-21-1.html">PLUMED Masterclass 21.1: PLUMED syntax and analysis</a>. Please ensure that you have setup PLUMED on your machine before starting the exercises.</p>
<h1><a class="anchor" id="masterclass-21-2-resources"></a>
Resources</h1>
<p>The data needed to execute the exercises of this Masterclass can be found on <a href="https://github.com/plumed/masterclass-21-2">GitHub</a>. You can clone this repository locally on your machine using the following command:</p>
<pre class="fragment">git clone https://github.com/plumed/masterclass-21-2.git
</pre><p>The data you need is in the folder called <code>data</code>. You will find the following files in that folder:</p>
<ul>
<li><code>uncorrelated_data</code>: you will analyze this data set in the first six exercises that follow</li>
<li><code>correlated_data</code>: you will analyze this data set in exercise 7</li>
<li><code>weighted_data</code>: you will analyze this data in exercise 8</li>
</ul>
<p>In exercise 9, you will pull everything together by generating a metadynamics trajectory. This exercise draws together all the ideas from exercises 1-8 by getting you to run a metadynamics simulation and extract the free energy surface. In the <code>data</code> folder, you will thus also find the following files, which are the input for the metadynamics simulation:</p>
<ul>
<li>in: The input file for simplemd that contains the parameters for the MD simulation.</li>
<li>input.xyz: An initial configuration for the cluster that we are studying in this tutorial.</li>
</ul>
<p>Notice that PLUMED input files have not been provided in the GitHub repository. You must prepare these input files yourself using the templates below.</p>
<p>We would recommend that you run each exercise in separate sub-directories inside the root directory <code>masterclass-21-2</code>.</p>
<dl class="section note"><dt>Note</dt><dd>All the exercises were tested with PLUMED version 2.7.0.</dd></dl>
<h1><a class="anchor" id="masterclass-21-2-structure"></a>
Background</h1>
<p><a class="el" href="masterclass-21-1.html">PLUMED Masterclass 21.1: PLUMED syntax and analysis</a> showed you how PLUMED can be used to calculate the value of a collective variables, \(s(\mathbf{x})\), from the positions of the atoms, \(\mathbf{x}\). You should also have seen that doing so allows you to describe the conformational changes or chemical reactions that have occured during your molecular dynamics trajectory. We will build on this idea in this tutorial by recalling that the values for collective variable we calculate for the frames of a constant-temperature molecular dynamics trajectory are samples from the probability distribution for <a href="https://www.notion.so/The-canonical-NVT-ensemble-112c3f99f215472cae55d5f6c36f4599">the canonical (NVT) ensemble</a>:</p>
<p class="formulaDsp">
\[ P(s&#39;) = \frac{ \int \textrm{d}x \textrm{d}p \delta( s(x) - s&#39;) e^{-\frac{H(x,p)}{k_B T}} }{ \int \textrm{d}x\textrm{d}p e^{-\frac{H(x,p)}{k_B T}} } \]
</p>
<p>where \(k_B\) is Boltzmann's constant, \(T\) is the temperature \(H(x,p)\) is the Hamiltonian and \(\delta\) is a Dirac delta function. Notice also that the integrals in the numerator and denominator are integrals over all of <a href="https://www.notion.so/Microstates-phase-space-and-the-principle-of-equal-a-priori-probabilities-9dbd484a47654bff858313634f01d875">phase space</a>. If \(N\) is the number of atoms in our system we must, therefore, integrate over each of the \(3N\) momentum ( \(p\)) and \(3N\) position ( \(x\)) coordinates when calculating these integrals. <br  />
</p>
<p>It is only possible to calculate the integrals in the quotient above exactly for elementary physical systems. For more complex systems we thus assume that we can extract information on \(P(s&#39;)\) by sampling from this distribution multiple times (using molecular dynamics or Monte Carlo) and using the tools of <a href="https://www.notion.so/940bd09c5be343888244beb21ed4a166?v=6bb0bd98d8fc47a081164069121ee396">statistics</a>. Critically, however, any result we get from such simulations is a <a href="https://www.notion.so/Random-variables-8aad5b4c3453423da3069168228fe890">random variable</a>. <b>To make our results <a href="https://www.notion.so/Reproducibility-2494dddd51a14d34bddbb40bb32f7ebc">reproducible</a> we thus need to characterize the <a href="https://www.notion.so/The-cumulative-probability-distribution-function-dc346bc8b4f1440b8d075f8c8d2b0f53">distribution</a> sampled in our simulation.</b> <br  />
 Reporting only the average value we get is not sufficient as any <a href="https://www.notion.so/Sample-mean-583d58d7001343c68a7956a1b9f19f4b">averages we take are random</a>.</p>
<p><em>Links to background information on statistical mechanics and statistics are provided throughout this tutorial. You can complete the tutorial without looking at the information at these links. However, we hope that the information we have provided through these links will prove useful if you want to do a more in-depth study of the topic.</em></p>
<h1><a class="anchor" id="masterclass-21-2-ex"></a>
Exercises</h1>
<h2><a class="anchor" id="masterclass-21-2-ex-1"></a>
Exercise 1: Calculating the average value of a CV</h2>
<p>We will start our study of averaging by estimating the <a href="https://www.notion.so/Ensembles-7b8b836f8ce44f9b8830ebb0fd00fea8">ensemble</a> average of the CV. The ensemble average for \(s(x)\) is given by:</p>
<p class="formulaDsp">
\[ \langle s \rangle = \frac{ \int \textrm{d}x \textrm{d}p s(x) e^{-\frac{H(x,p)}{k_B T}} }{ \int \textrm{d}x\textrm{d}p e^{-\frac{H(x,p)}{k_B T}} } \]
</p>
<p>This equation is the same quotient that was introduced for \(P(s&#39;)\) in <a class="el" href="masterclass-21-2.html#masterclass-21-2-structure">Background</a> but with the Dirac delta replaced by \(s(x)\).</p>
<p>In statistics, the quantity known as the ensemble average in statistical mechanics is referred to as the <a href="https://www.notion.so/Expectation-c877d8e2ab444b818fae6c053598e0af">expectation</a> of the random variable's <a href="https://www.notion.so/The-cumulative-probability-distribution-function-dc346bc8b4f1440b8d075f8c8d2b0f53">distribution</a>. The expectation of a random variable is often esimated by taking multiple identical samples from the distribution, \(X_i\) and computing a <a href="https://www.notion.so/Sample-mean-583d58d7001343c68a7956a1b9f19f4b">sample mean</a> as follows:</p>
<p class="formulaDsp">
\[ \overline{X} = \frac{1}{N} \sum_{i=1}^N X_i \]
</p>
<p>We can do the same with the data from our MD trajectory. We replace the \(X_i\) in the equation above with the CV values calculated for each of our trajectory frames.</p>
<p>To calculate averages using PLUMED, you can use the input file below. This input calculates averages for the data in the <code>uncorrelated_data</code> file you downloaded when you collected the GitHub repository. <br  />
</p>

<div style="width: 90%; float:left" id="value_details_eg1"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<b name="eg1data" onclick='showPath("eg1","eg1data")'>data: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg1data"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg1av" onclick='showPath("eg1","eg1av")'>av: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_a_v_e_r_a_g_e.html" style="color:green">AVERAGE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=1 <span style="display:none;" id="eg1av"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg1av">av</b> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=colvar <span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p><b>Copy the input to a file called plumed.dat, fill in the blanks and run the calculation by executing the following command:</b></p>
<pre class="fragment">&gt; plumed driver --noatoms
</pre><p>The <code>colvar</code> file that is output by PLUMED contains the average computed value from progressively larger and larger numbers of CV values. You should thus be able to use the data in <code>colvar</code> to produce a graph that shows the average as a function of the number of variables it is computed from as shown below.</p>
<p><a class="anchor" id="masterclass-21-2-fig1"></a></p><div class="image">
<img src="masterclass-21-2-average.png" alt=""/>
<div class="caption">
Average CV as a function of the number of variables it is computed from</div></div>
<p>The fluctuations in the average get smaller as this quantity is computed from larger numbers of random variables. We say that the average thus converges to the ensemble average, which is zero for the graph above.</p>
<h2><a class="anchor" id="masterclass-21-2-ex-2"></a>
Exercise 2: Calculating the free energy</h2>
<p>We can estimate the distribution for our CV, \(P(s&#39;)\) (see <a class="el" href="masterclass-21-2.html#masterclass-21-2-structure">Background</a>), by calculating <a href="https://www.notion.so/Histogram-2d2527795f0140008b318d3bc958ee4c">a histogram</a>. The histogram we obtain is a sample from <a href="https://www.notion.so/Multinomial-distribution-f378b34a38564f6999e184cd2df53f5c">a multinomial distribution</a> so we can estimate parameters for the multinomial by using <a href="https://www.notion.so/Maximum-likelihood-e74a16b691284896bb2bbd5cff502f6d">likelihood maximisation</a>. Once we have the marginal distribution, \(P(s&#39;)\) we can then calculate the <a href="https://www.notion.so/Thermodynamic-potentials-dd0dcbab15cd437b91e803ac7fbd1bf8">free energy</a>, \(F(s&#39;)\) as a function of \(s(x)\) as \(F(s&#39;)\) is related to \(P(s&#39;)\) (see <a class="el" href="masterclass-21-2.html#masterclass-21-2-structure">Background</a>) by:</p>
<p class="formulaDsp">
\[ F(s&#39;) = - k_B T \ln P(s&#39;) \]
</p>
<p>If we estimate \(P(s&#39;)\) using likelihood maximisation we can thus get an estimate of the free energy surface. To estimate the free energy surface for the data in <code>uncorrelated_data</code> using PLUMED in this way we can use the input file:</p>

<div style="width: 90%; float:left" id="value_details_eg2"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># We use natural units here so that kBT is set to 1</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_u_n_i_t_s.html" style="color:green">UNITS</a> <div class="tooltip">NATURAL<div class="right">( default=off ) use natural units <i></i></div></div> <span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2data" onclick='showPath("eg2","eg2data")'>data: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg2data"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2hhh" onclick='showPath("eg2","eg2hhh")'>hhh: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=1 <div class="tooltip">__FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=-4.5 <div class="tooltip">__FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=4.5 <div class="tooltip">__FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=100 <div class="tooltip">__FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=DISCRETE <span style="display:none;" id="eg2hhh"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2fes" onclick='showPath("eg2","eg2fes")'>fes: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_o_n_v_e_r_t__t_o__f_e_s.html" style="color:green">CONVERT_TO_FES</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the input grid you would like to use <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">TEMP<div class="right">the temperature at which you are operating <i></i></div></div>=1 <span style="color:blue"># This sets k_B T = 1 </span><span style="display:none;" id="eg2fes"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=<b name="eg2fes">fes.dat</b> <span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p><b>Copy this input to a file called plumed.dat, fill in the blanks so that you have a grid that runs from -4 to +4 with 100 bins. Run the calculation by executing the following command:</b></p>
<pre class="fragment">&gt; plumed driver --noatoms
</pre><p>The <code>--noatoms</code> flag here is needed since <code>plumed driver</code> is commonly used to analize a trajectory of atomic coordinates, but here we are using it to directly analyze a collective variable.</p>
<p>You should see that the free energy curve for this data set looks like this:</p>
<p><a class="anchor" id="masterclass-21-2-fig2"></a></p><div class="image">
<img src="masterclass-21-2-fes1.png" alt=""/>
<div class="caption">
The free energy as a function of the CV for the data in uncorrelated_data.</div></div>
<p>As you can see, there is a single minimum in this free energy surface.</p>
<h2><a class="anchor" id="masterclass-21-2-ex-3"></a>
Exercise 3: Calculating the fluctuations for a CV</h2>
<p>Physical systems spend the majority of their time fluctuating around minima in the free energy landscape. Let's suppose that this minima is at \(\mu\) and lets use the Taylor series to write an expression for the free energy at \(s&#39;\) as follows:</p>
<p class="formulaDsp">
\[ F(s) = F(\mu) + F&#39;(\mu)(s-\mu) + \frac{F&#39;&#39;(\mu)(s-\mu)^2}{2!} + \dots + \frac{F^{(n)}(\mu)(s-\mu)^n}{n!} + \dots \]
</p>
<p>In this expression \(F&#39;(\mu)\), \(F&#39;&#39;(\mu)\) and \(F^{(n)}(\mu)\) are the first, second and \(n\)th derivatives of the free energy at \(\mu\). We know there is a minimum at \(\mu\) so \(F&#39;(\mu)=0\). If we truncate the expansion at second order we can, therefore, write:</p>
<p class="formulaDsp">
\[ F(s) \approx F(\mu) + \frac{F&#39;&#39;(\mu)(s-\mu)^2}{2} \]
</p>
<p>We now recall that \(F(s) = - k_B T \ln P(s&#39;)\) and thus write:</p>
<p class="formulaDsp">
\[ P(s) = \exp\left( -\frac{F(s)}{k_B T} \right) \approx \exp\left( -\frac{F(\mu) + \frac{F&#39;&#39;(\mu)(s-\mu)^2}{2} }{k_B T} \right) = \exp\left( -\frac{F(\mu)}{k_B T} \right)\exp\left( - \frac{F&#39;&#39;(\mu)(s-\mu)^2}{2k_B T} \right) \]
</p>
<p>The first term in the final product here is a constant that does not depend on \(s\), while the second is a Gaussian centered on \(\mu\) with \(\sigma^2 = \frac{k_B T}{F&#39;&#39;(\mu)}\). <br  />
 We can assume that the constant term in the product above normalizes the distribution. The derivation above, therefore, suggests that our CV values are all samples from a <a href="https://www.notion.so/Normal-random-variable-86cae0d838314a3cb8aead626dc6647e">normal distribution</a>. We thus no longer need to estimate the histogram to get information on \(P(s&#39;)\). If \(P(s&#39;)\) is indeed a normal distribution, it is fully characterized if we have the two parameters \(\mu\) and \(\sigma\).</p>
<p>Statistics tells us that if we have \(N\) identical normal random variables, \(X_i\) we can estimate <a href="https://www.notion.so/Sample-mean-583d58d7001343c68a7956a1b9f19f4b">\(\mu\)</a> and <a href="https://www.notion.so/Variance-3688f3132bd64d3fbc2f022d7ee17e88">\(\sigma\)</a> using:</p>
<p class="formulaDsp">
\[ \mu = \frac{1}{N} \sum X_i \qquad \qquad \sigma = \sqrt{ \frac{N}{N-1} \left[ \frac{1}{N} \sum_{i=1}^N X_i^2 - \left( \frac{1}{N}\sum_{i=1}^N X_i \right)^2 \right] } \]
</p>
<p>We learned how to estimate \(\mu\) using these expressions in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-1">Exercise 1: Calculating the average value of a CV</a>. To estimate \(\sigma^2\) for the data in <code>uncorrelated_data</code> using PLUMED and the expression above we can use the following input file:</p>

<div style="width: 90%; float:left" id="value_details_eg3"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<b name="eg3data" onclick='showPath("eg3","eg3data")'>data: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg3data"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># This line should calculate the square of the quantity read in from the file above</span>
<b name="eg3d2" onclick='showPath("eg3","eg3d2")'>d2: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_u_s_t_o_m.html" style="color:green">CUSTOM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FUNC<div class="right"><b>compulsory keyword </b>
the function you wish to evaluate <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">PERIODIC<div class="right"><b>compulsory keyword </b>
if the output of your function is periodic then you should specify the periodicity
of the function. <i></i></div></div>=NO <span style="display:none;" id="eg3d2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate the average from the read-in data</span>
<b name="eg3av" onclick='showPath("eg3","eg3av")'>av: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_a_v_e_r_a_g_e.html" style="color:green">AVERAGE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=1 <span style="display:none;" id="eg3av"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate the average of the squares of the read in data</span>
<b name="eg3av2" onclick='showPath("eg3","eg3av2")'>av2: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_a_v_e_r_a_g_e.html" style="color:green">AVERAGE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=1 <span style="display:none;" id="eg3av2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Evaluate the variance using the expression above</span>
<b name="eg3var" onclick='showPath("eg3","eg3var")'>var: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_u_s_t_o_m.html" style="color:green">CUSTOM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FUNC<div class="right"><b>compulsory keyword </b>
the function you wish to evaluate <i></i></div></div>=y-x*x <div class="tooltip">PERIODIC<div class="right"><b>compulsory keyword </b>
if the output of your function is periodic then you should specify the periodicity
of the function. <i></i></div></div>=NO <span style="display:none;" id="eg3var"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Print the variance</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=colvar <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p><b>Copy this input to a file called plumed.dat, fill in the blanks and run the calculation by executing the following command:</b></p>
<pre class="fragment">&gt; plumed driver --noatoms
</pre><p>Once you have run this calculation, you should be able to draw a graph showing how the estimate of \(\sigma\) changes as a function of the number of CVs used in its calculation. As you can see from the graph below, \(\sigma\) quantity behaves similarly to the mean that we studied in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-1">Exercise 1: Calculating the average value of a CV</a></p>
<p><a class="anchor" id="masterclass-21-2-fig3"></a></p><div class="image">
<img src="masterclass-21-2-var.png" alt=""/>
<div class="caption">
Estimate of the standard deviation for the CV as a function of the number of samples it is computed from</div></div>
<p><em>Truncation the Taylor series of the free energy at second order as we have done in this section is equivalent to assuming that a <a href="https://www.notion.so/Harmonic-Oscillator-92855b39d13945dabb73cb831dc1234e">Harmonic Oscillator</a> can be used to describe the fluctuations along our CV. The <a href="https://www.notion.so/Generalised-partition-function-10ed8ca2b3c943aa82dff2116ae955e5">partition function</a>, ensemble average and distribution for such systems can be calculated exactly, and there is no need for simulation. Even when the system is not harmonic, calculating the quantity we have called \(\sigma^2\) in this section is still useful as this quantity is an estimator for the <a href="https://www.notion.so/Variance-3688f3132bd64d3fbc2f022d7ee17e88">variance</a> of the distribution. For anharmonic systems, there is not a simple closed-form expression between the variance ( \(\sigma^2\)) and the second derivative of the free energy at \(\mu\) though.</em></p>
<h2><a class="anchor" id="masterclass-21-2-ex-4"></a>
Exercise 4: Calculating block averages</h2>
<p>The following PLUMED input splits the CV values into blocks and calculates <a href="https://www.notion.so/Sample-mean-583d58d7001343c68a7956a1b9f19f4b">an average</a> from each block of data separately. We can thus use it to get information on <a href="https://www.notion.so/The-cumulative-probability-distribution-function-dc346bc8b4f1440b8d075f8c8d2b0f53">the distribution</a> that is being sampled when we calculate an average from sets of 500 random variables using the ideas discussed in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-1">Exercise 1: Calculating the average value of a CV</a>. <br  />
</p>

<div style="width: 90%; float:left" id="value_details_eg4"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<b name="eg4data" onclick='showPath("eg4","eg4data")'>data: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg4data"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4av" onclick='showPath("eg4","eg4av")'>av: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_a_v_e_r_a_g_e.html" style="color:green">AVERAGE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=1 <div class="tooltip">CLEAR<div class="right"><b>compulsory keyword ( default=0 )</b>
the frequency with which to clear all the accumulated data. <i></i></div></div>=500 <span style="display:none;" id="eg4av"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=colvar <span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p><b>Copy this input to a file called plumed.dat, fill in the blanks and run the calculation by executing the following command:</b></p>
<pre class="fragment">&gt; plumed driver --noatoms
</pre><p>Plot a graph showing the original data from <code>uncorrelated_data</code> and the averages in the <code>colvar</code> file. You should be able to see something similar to this graph.</p>
<p><a class="anchor" id="masterclass-21-2-fig4"></a></p><div class="image">
<img src="masterclass-21-2-block-average.png" alt=""/>
<div class="caption">
The yellow points are block averages computed from the data points shown in black.</div></div>
<p>Notice how the distribution for both the black (original data) and yellow points (averages) in this graph are centred on the same quantity. Both of these quantities are thus <a href="https://www.notion.so/Point-estimation-d4225267e03e4539a2e85d08b9e9efad">accurate estimators</a> for the expectation of the distribution. However, the block average that is shown in yellow is a more <a href="https://www.notion.so/Point-estimation-d4225267e03e4539a2e85d08b9e9efad">precise estimator</a> for this quantity. <br  />
</p>
<p>The reason the block average is a more precise estimator is connected to a well known result in statistics. If we compute a mean as follows:</p>
<p class="formulaDsp">
\[ \overline{X} = \frac{1}{N} \sum_{i=1}^N X_i \]
</p>
<p>where the \(X_i\) are all <a href="https://www.notion.so/Independence-00fd3064fd3e4aa3b677d7fec6ecedcd">independent</a> and <a href="https://www.notion.so/Random-variables-8aad5b4c3453423da3069168228fe890">identical</a> random variables it is <a href="https://www.notion.so/Sample-mean-583d58d7001343c68a7956a1b9f19f4b">straghtforward to show</a> that the expectation and variance of this random quantity are given by:</p>
<p class="formulaDsp">
\[ \mathbb{E}(\overline{X}) = \mathbb{E}(X) \qquad \textrm{and} \qquad \textrm{var}(\overline{X}) = \frac{\textrm{var}(X)}{N} \]
</p>
<p>where \(\mathbb{E}(X)\) and \(\textrm{var}(X)\) are the expectation and variance of the random variable \(X_i\) from which the mean was computed.</p>
<h2><a class="anchor" id="masterclass-21-2-ex-5"></a>
Exercise 5: Free energy from block averages</h2>
<p>We can use the block averaging method introduced in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-4">Exercise 4: Calculating block averages</a> to calculate error bars on the estimates of free energy. To generate 10 histograms from the data in <code>uncorrelated_data</code> with 100 bins starting at -4 and finishing at +4 using PLUMED we can use the input file:</p>

<div style="width: 90%; float:left" id="value_details_eg5"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<b name="eg5data" onclick='showPath("eg5","eg5data")'>data: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg5data"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg5hhh" onclick='showPath("eg5","eg5hhh")'>hhh: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=__FILL__STRIDE=1 <div class="tooltip">__FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=-4.5 <div class="tooltip">__FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=4.5 <div class="tooltip">__FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=100 <div class="tooltip">CLEAR<div class="right"><b>compulsory keyword ( default=0 )</b>
the frequency with which to clear all the accumulated data. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">_FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=DISCRETE <span style="display:none;" id="eg5hhh"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=hist.dat <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=0 )</b>
the frequency with which the grid should be output to the file. <i></i></div></div>=1000 <span style="display:none;" id="eg5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p><b>Copy this input to a file called plumed.dat, fill in the blanks and run the calculation by executing the following command:</b></p>
<pre class="fragment">&gt; plumed driver --noatoms
</pre><p>Running this command should generate several files containing histograms that will be called: analysis.0.hist.dat, analysis.1.hist.dat etc. These files contain the histograms constructed from each of the blocks of data in your trajectory. You can merge them all to get the final free energy surface, which can be calculated using the well-known relation between the histogram, \(P(s)\), and the free energy surface, \(F(s)\), by using the following python script:</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div>
<div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"><span class="keyword">import</span> glob</div>
<div class="line"> </div>
<div class="line">hist1 = np.loadtxt(<span class="stringliteral">&quot;../Exercises/Exercise_5/hist.dat&quot;</span>)</div>
<div class="line">N, average, average2 = 1, hist1[:,1], hist1[:,1]*hist1[:,1]</div>
<div class="line"><span class="keywordflow">for</span> filen <span class="keywordflow">in</span> glob.glob( <span class="stringliteral">&quot;../Exercises/Exercise_5/analysis.*.hist.dat&quot;</span>) : </div>
<div class="line">    histn = np.loadtxt(filen)</div>
<div class="line">    N, average, average2 = N + 1, average + histn[:,1], average2 + histn[:,1]*histn[:,1]</div>
<div class="line">    </div>
<div class="line"><span class="comment"># Final averages </span></div>
<div class="line">average = average / N</div>
<div class="line"><span class="comment"># Final variances</span></div>
<div class="line">var = (N/(N-1))*( average2 / N - average*average ) </div>
<div class="line"><span class="comment"># Errors</span></div>
<div class="line">error = np.sqrt( var / N )</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Convert to free energy </span></div>
<div class="line">fes = -np.log( average )</div>
<div class="line"><span class="comment"># Convert to error in fes</span></div>
<div class="line">ferr = error / average </div>
<div class="line"> </div>
<div class="line"><span class="comment"># And draw graph of free energy surface</span></div>
<div class="line">plt.fill_between( hist1[:,0], fes-ferr, fes+ferr )</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;CV value&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&#39;Free energy&#39;</span>)</div>
<div class="line">plt.show()</div>
</div><!-- fragment --><p>Copy this script to a cell in a python notebook and then run it on your data. <br  />
 You may need to adjust the names of the files that are being read to suit your machine's setup. The graph shown in the figure below shows the free energy surface generated from the python script. <br  />
</p>
<p><a class="anchor" id="masterclass-21-2-fig5"></a></p><div class="image">
<img src="masterclass-21-2-fes2.png" alt=""/>
<div class="caption">
The free energy as a function of the CV for the data in uncorrelated_data. The shaded region shows the errors on this estimate. These errors were computed using block averaging.</div></div>
<p>The value of the free energy in the \(i\)th bin is calculated using:</p>
<p class="formulaDsp">
\[ F_i = -k_B T \ln \left( \frac{1}{N} \sum_{j=1}^N H_i^{(j)} \right) \]
</p>
<p>The sum here runs over the \(N\) histograms and \(H_i^{(j)}\) is the value of \(i\)th bin in the \(j\)th estimate of the histogram. The above expression is thus calculating the logarithm of the histogram's average value in bin \(i\).</p>
<p>The error on the free energy, which is illustrated using the shaded region in the figure above, is calculated using:</p>
<p class="formulaDsp">
\[ \sigma_{F_i} = \frac{k_B T}{\frac{1}{N} \sum_{j=1}^N H_i^{(j)}} \sqrt{\frac{1}{N-1} \left[ \frac{1}{N}\sum_{j=1}^N (H_i^{(j)})^2 - \left( \frac{1}{N}\sum_{j=1}^N H_i^{(j)} \right)^2 \right] } \]
</p>
<p>The term in the square root here is the error on the average value of the histogram in bin \(i\). The error on this <a href="https://www.notion.so/Sample-mean-583d58d7001343c68a7956a1b9f19f4b">average</a> can be calculated using the formulas in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-4">Exercise 4: Calculating block averages</a>. To get the error on the free energy, we then have to propagate the errors through the expression:</p>
<p class="formulaDsp">
\[ F(s) = - k_B T \ln\left( P(s) \right) \]
</p>
<p>to get the expression above.</p>
<p>Lastly, notice that it is often useful to average the error over the grid using:</p>
<p class="formulaDsp">
\[ \sigma = \frac{1}{M} \sum_{i=1}^M F_i \]
</p>
<p>where the sum runs over the \(M\) bins in the histogram.</p>
<h2><a class="anchor" id="masterclass-21-2-ex-6"></a>
Exercise 6: Calculating bootstrap averages</h2>
<p><a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-4">Exercise 4: Calculating block averages</a> demonstrated one way of sampling the mean's distribution (see <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-1">Exercise 1: Calculating the average value of a CV</a>). We assumed that the \(M\) estimates of the mean were all normal random variables in the previous section but we did not need to do that. We could instead have used a non-parametric method. When using such methods we have to generate more data, which we can either do by running longer simulations, which is expensive, or by bootstrapping, which is cheaper. <br  />
</p>
<p>We can demonstrate how bootstrapping works in practice by using the following script, which works with the first 500 points in <code>uncorrelated_data</code>. As you can see, we first calculate the average from all the data points. We then take new means by repeatedly sampling sets of 500 points with replacement from the data and calculating new means. <br  />
</p>
<div class="fragment"><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"> </div>
<div class="line">ddd = np.loadtxt(<span class="stringliteral">&quot;../data/uncorrelated_data&quot;</span>)</div>
<div class="line">data = ddd[0:500,1]</div>
<div class="line"> </div>
<div class="line">bootstraps = np.zeros(200)</div>
<div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(200) : </div>
<div class="line">    av = 0</div>
<div class="line">    <span class="keywordflow">for</span> j <span class="keywordflow">in</span> range(500) : av = av + data[np.random.randint(0,500)]</div>
<div class="line">    bootstraps[i] = av / 500 </div>
<div class="line"> </div>
<div class="line">f = open(<span class="stringliteral">&quot;bootstraps&quot;</span>, <span class="stringliteral">&quot;w&quot;</span>)</div>
<div class="line">f.write(<span class="stringliteral">&quot;#! FIELDS time boot \n&quot;</span>)</div>
<div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(0,200):</div>
<div class="line">    f.write(str(i) + <span class="stringliteral">&quot; &quot;</span>  + str(bootstraps[i) + <span class="stringliteral">&quot;\n&quot;</span> )</div>
<div class="line">f.close()</div>
</div><!-- fragment --><p>When you run the script above, it generates a file called <code>bootstraps</code> containing the averages that have been calculated by bootstrapping. <br  />
 If you now calculate the variance from all your bootstrapped averages you should see that it close to the value you got from the expression below which was introduced in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-4">Exercise 4: Calculating block averages</a>:</p>
<p class="formulaDsp">
\[ \textrm{var}(\overline{X}) = \frac{\textrm{var}(X)}{N} \]
</p>
<p>To use this expression you can insert the value of \(\textrm{var}(X)\) you computed in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-3">Exercise 3: Calculating the fluctuations for a CV</a> with \(N=500\). <br  />
</p>
<p><em>You can also use bootstrapping to estimate the errors in the free energy surface. As an additional exercise, you can try to do this form of analysis on the data in <code>uncorrelated_data</code> You should get a result that is similar to the result you got in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-5">Exercise 5: Free energy from block averages</a></em></p>
<h2><a class="anchor" id="masterclass-21-2-ex-7"></a>
Exercise 7: Dealing with correlated data</h2>
<p>In this exercise, you will review everything you have done in the previous two sections. <b>You should</b>:</p>
<ul>
<li>Calculate block averages for the data in <code>correlated_data</code>. Calculate the error on the average of the block average. <br  />
</li>
<li>Calculate bootstrap averages for the data in <code>correlated_data</code>. Calculate the error from the bootstrap averages.</li>
</ul>
<p>You will see that the variance you obtain from the bootstrap averages is less than the variance you get by block averaging.</p>
<p>These variances are different because there are correlations between the data points in <code>correlated_data</code>. Such correlations were not present in the data set you have examined in all the exercises that appeared previously to this one. The reason this matters is that the expression:</p>
<p class="formulaDsp">
\[ \textrm{var}(\overline{X}) = \frac{\textrm{var}(X)}{N} \]
</p>
<p>is only valid if the random variables that \(\overline{X}\) is computed from are both identical and <a href="https://www.notion.so/Independence-00fd3064fd3e4aa3b677d7fec6ecedcd"><b>independent</b></a>. This expression is thus not valid for correlated data. To be clear, however, we can still write:</p>
<p class="formulaDsp">
\[ \mathbb{E}(\overline{X}) = \mathbb{E}(X) \]
</p>
<p>as this expression holds as long as the random variables from which \(\overline{X}\) are <a href="https://www.notion.so/Random-variables-8aad5b4c3453423da3069168228fe890">identical</a>. When we use this expression, the random variables only need to be independent and can be correlated.</p>
<p><b>Any data we get by computing CVs from a molecular dynamics trajectory is almost certain to contain correlations.</b> It is thus essential to know how to handle correlated data. The block averaging technique that was introduced in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-4">Exercise 4: Calculating block averages</a> resolves this problem. You can show that if the blocks are long enough, the averages you obtain are uncorrelated.</p>
<p>For the remainder of this exercise, you should use the data in <code>correlated_data</code> and what you have learned in the previous exercises to calculate block averages for different block sizes. <br  />
 For each block size</p>
<ul>
<li>Estimate the mean and variance for your \(N\) block averages (the \(X_i\)) using \(\mu = \frac{1}{N} \sum X_i\) and \(\sigma^2 = \frac{N}{N-1} \left[ \frac{1}{N} \sum_{i=1}^N X_i^2 - \left( \frac{1}{N}\sum_{i=1}^N X_i \right)^2 \right] \) <br  />
</li>
<li>Insert your estimate of the variance into the following expression for the error bar on your estimate for \(\mu\): \(\epsilon = \sqrt{\frac{\sigma^2}{N}}\)</li>
</ul>
<p>You should be able to use your data to draw a graph showing the value of the average and the associated error barm \(\epsilon\), as a function of the size of the blocks similar to the one shown below:</p>
<p><a class="anchor" id="masterclass-21-2-fig7"></a></p><div class="image">
<img src="masterclass-21-2-corr-baverage.png" alt=""/>
<div class="caption">
Average of blocks as a function of the blocks' size for the correlated data. The bar shows the size of the error on the estimate of the average.</div></div>
<p>This graph shows that, when the data is correlated, the error bar is underestimated if each block average is computed from a small number of data points. When sufficient data points are used to calculate each block average, however, the error bar settles on a constant value that is independent of the block size. When this has happened you can be confident that your block averages are no longer correlated and the expression \(\textrm{var}(\overline{X}) = \frac{\textrm{var}(X)}{N}\) is thus valid.</p>
<p><em>Notice that you can also calculate the error bar using bootstrapping by selecting samples from your block averages. If you have time, you should try this. You should try to confirm that this method gives similar estimates for the error.</em></p>
<h2><a class="anchor" id="masterclass-21-2-ex-8"></a>
Exercise 8: Weighted averages</h2>
<p>PLUMED is routinely used to run simulations using methods such as umbrella sampling and metadynamics. In these methods, a bias potential, \(V(x)\), is added to the Hamiltonian to enhance the sampling of phase space. CVs calculated from the frames of such biased MD simulations thus samples from the following distribution:</p>
<p class="formulaDsp">
\[ P(s&#39;) = \frac{ \int \textrm{d}x \textrm{d}p \delta( s(x) - s&#39;) e^{-\frac{H(x,p)}{k_B T}} e^{-\frac{V(x)}{k_B T}} }{ \int \textrm{d}x\textrm{d}p e^{-\frac{H(x,p)}{k_B T}}e^{-\frac{V(x)}{k_B T}} } \]
</p>
<p>To get information on the unbiased distribution:</p>
<p class="formulaDsp">
\[ P(s&#39;) = \frac{ \int \textrm{d}x \textrm{d}p \delta( s(x) - s&#39;) e^{-\frac{H(x,p)}{k_B T}} }{ \int \textrm{d}x\textrm{d}p e^{-\frac{H(x,p)}{k_B T}} } \]
</p>
<p>from such simulations we thus have to calculate <a href="https://www.notion.so/Weighted-averages-81a28555cc3149f78047f80bb9dbba91">weighted averages</a> using:</p>
<p class="formulaDsp">
\[ \overline{X}_w = \frac{\sum_{i=1}^N w_i X_i }{\sum_{i=1}^N w_i} \]
</p>
<p>where the \(w_i\) are (random) weights that counteract the effect of the bias. The way the weights are calculated is described in <a class="el" href="masterclass-21-3.html">PLUMED Masterclass 21.3: Umbrella sampling</a>)</p>
<p>In this exercise we are going to reweight the data in <code>weighted_data</code>, which consists of samples from the following distribution:</p>
<p class="formulaDsp">
\[ P(x) = \frac{1}{\sqrt{2\pi}\sigma} \exp\left( -\frac{(x-\mu)^2}{2\sigma^2} \right) \]
</p>
<p>with \(\mu=0.6\) and \(\sigma=0.5\) with and additional constrant that \(0&lt;x&lt;1\). Given this information the following weighted average:</p>
<p class="formulaDsp">
\[ \overline{X}_w = \frac{\sum_{i=1}^N w_i X_i }{\sum_{i=1}^N w_i} \qquad \textrm{where} \qquad w_i = \frac{1}{P(X_i)} \]
</p>
<p>should be an estimator for the expectation of a uniform random variable between 0 and 1. Furthermore, the expression below:</p>
<p class="formulaDsp">
\[ \sigma^2_{X} = \frac{V_1}{V_1-1} \sum_{i=1}^N \frac{w_i}{V_1} (x_i - \overline{X}_w)^2 \qquad \textrm{where} \qquad V_1 = \sum_{i=1}^N w_i \]
</p>
<p>gives an estimate for the variance of <b>the distribution</b> after reweighting (i.e. the variance of the uniform random variable).</p>
<p>Notice, finally, that the tools of statistics gives us expressions for the <a href="https://www.notion.so/Weighted-averages-81a28555cc3149f78047f80bb9dbba91">expectation and variance of the <b>weighted average</b></a>:</p>
<p class="formulaDsp">
\[ \mathbb{E}(\overline{X}_w) = \overline{X} \qquad \textrm{and} \qquad \textrm{var}(\overline{X}_w) = \frac{\sum_{i=1}^N w_i^2 (X_i - \overline{X}_w)^2 }{(\sum_{i=1}^N w_i)^2} \]
</p>
<p>These expressions hold if all the \(X_i\) from which the weighted average is computed are independent and identically distributed random variables. Notice, furthermore, how the expression above for the the variance of the weighted average <b>is not</b> a function of the variance for the variable as was the case for the unweighted averages in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-4">Exercise 4: Calculating block averages</a>.</p>
<p>In what follows we are thus going to try to extract the average and the fluctuations for the CV in the unbiased (in this case uniform) distribution as well as the unbiased free energy. We will calculate these quantities by computing weighted averages and <a href="https://www.notion.so/Weighted-histograms-546d0b3837ce43a3b9de0dcf7a741353">weighted histograms</a> from our simulation data. For the histogram we are also going to extract error bars by reweighting. To calculate these quantities using PLUMED we will use an input like this:</p>

<div style="width: 90%; float:left" id="value_details_eg6"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_u_n_i_t_s.html" style="color:green">UNITS</a> <div class="tooltip">NATURAL<div class="right">( default=off ) use natural units <i></i></div></div> <span style="color:blue"># This ensures that Boltzmann's constant is one </span><span style="display:none;" id="eg6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6data" onclick='showPath("eg6","eg6data")'>data: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg6data"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># This restraint and the REWEIGHT_BIAS command after computes the weights in the formulas above.</span>
<b name="eg6mm" onclick='showPath("eg6","eg6mm")'>mm: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_s_t_r_a_i_n_t.html" style="color:green">RESTRAINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg6data">data</b> <div class="tooltip">AT<div class="right"><b>compulsory keyword </b>
the position of the restraint <i></i></div></div>=0.6 <div class="tooltip">KAPPA<div class="right"><b>compulsory keyword ( default=0.0 )</b>
specifies that the restraint is harmonic and what the values of the force constants
on each of the variables are <i></i></div></div>=4 <span style="display:none;" id="eg6mm"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6rw" onclick='showPath("eg6","eg6rw")'>rw: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_w_e_i_g_h_t__b_i_a_s.html" style="color:green">REWEIGHT_BIAS</a> <div class="tooltip">TEMP<div class="right">the system temperature. <i></i></div></div>=1 <span style="display:none;" id="eg6rw"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6wav" onclick='showPath("eg6","eg6wav")'>wav: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_a_v_e_r_a_g_e.html" style="color:green">AVERAGE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=1 <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg6wav"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># These lines compute the variance of the random variable</span>
<b name="eg6dd" onclick='showPath("eg6","eg6dd")'>dd: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_u_s_t_o_m.html" style="color:green">CUSTOM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg6data">data</b>,<b name="eg6wav">wav</b> <div class="tooltip">FUNC<div class="right"><b>compulsory keyword </b>
the function you wish to evaluate <i></i></div></div>=(x-y)*(x-y) <div class="tooltip">PERIODIC<div class="right"><b>compulsory keyword </b>
if the output of your function is periodic then you should specify the periodicity
of the function. <i></i></div></div>=NO <span style="display:none;" id="eg6dd"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6uvar" onclick='showPath("eg6","eg6uvar")'>uvar: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_a_v_e_r_a_g_e.html" style="color:green">AVERAGE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg6dd">dd</b> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=1 <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<b name="eg6rw">rw</b> <div class="tooltip">NORMALIZATION<div class="right"><b>compulsory keyword ( default=true )</b>
This controls how the data is normalized it can be set equal to true, false or ndata.
<i></i></div></div>=false <span style="display:none;" id="eg6uvar"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6one" onclick='showPath("eg6","eg6one")'>one: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_o_n_s_t_a_n_t.html" style="color:green">CONSTANT</a> <div class="tooltip">VALUE<div class="right">The value of the constant <i></i></div></div>=1 <span style="display:none;" id="eg6one"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6wsum" onclick='showPath("eg6","eg6wsum")'>wsum: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_a_v_e_r_a_g_e.html" style="color:green">AVERAGE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg6one">one</b> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=1 <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<b name="eg6rw">rw</b> <div class="tooltip">NORMALIZATION<div class="right"><b>compulsory keyword ( default=true )</b>
This controls how the data is normalized it can be set equal to true, false or ndata.
<i></i></div></div>=false <span style="display:none;" id="eg6wsum"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg6var" onclick='showPath("eg6","eg6var")'>var: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_u_s_t_o_m.html" style="color:green">CUSTOM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg6uvar">uvar</b>,<b name="eg6wsum">wsum</b> <div class="tooltip">FUNC<div class="right"><b>compulsory keyword </b>
the function you wish to evaluate <i></i></div></div>=x/(y-1) <div class="tooltip">PERIODIC<div class="right"><b>compulsory keyword </b>
if the output of your function is periodic then you should specify the periodicity
of the function. <i></i></div></div>=NO <span style="display:none;" id="eg6var"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Print out the average and variance of the uniform random variable</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=1 <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=colvar <span style="display:none;" id="eg6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Construct the histogram</span>
<b name="eg6hhh" onclick='showPath("eg6","eg6hhh")'>hhh: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">__FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=0 <div class="tooltip">__FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=1 <div class="tooltip">__FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=20 <div class="tooltip">CLEAR<div class="right"><b>compulsory keyword ( default=0 )</b>
the frequency with which to clear all the accumulated data. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">NORMALIZATION<div class="right"><b>compulsory keyword ( default=ndata )</b>
This controls how the data is normalized it can be set equal to true, false or ndata.
<i></i></div></div>=true <div class="tooltip">__FILL__<div class="right"><b> could not find this keyword </b><i></i></div></div>=DISCRETE <span style="display:none;" id="eg6hhh"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=hist.dat <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=0 )</b>
the frequency with which the grid should be output to the file. <i></i></div></div>=1000 <span style="display:none;" id="eg6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p><b>Copy this input to a file called plumed.dat, fill in the blanks and run the calculation by executing the following command:</b></p>
<pre class="fragment">&gt; plumed driver --noatoms
</pre><p>I obtained the following graphs showing how the mean and variance change with sample size. <br  />
</p>
<p><a class="anchor" id="masterclass-21-2-fig8a"></a></p><div class="image">
<img src="masterclass-21-2-average8.png" alt=""/>
<div class="caption">
Average value of the random variable and the fluctuations as a function of sample size.</div></div>
<p>The free energy with errors from this data looks like this:</p>
<p><a class="anchor" id="masterclass-21-2-fig8b"></a></p><div class="image">
<img src="masterclass-21-2-fes8.png" alt=""/>
<div class="caption">
Free energy (with errors) as a function of the CV computed by reweighting</div></div>
<p><b>It is up to you to work out how to adapt the script given in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-5">Exercise 5: Free energy from block averages</a>, so it works here. The script above works for unweighted means. Here, however, you have to calculate weighted means using the formulas above.</b></p>
<h2><a class="anchor" id="masterclass-21-2-ex-9"></a>
Exercise 9: The free energy from a biased simulation</h2>
<p>We can now bring all this together by running a metadynamics simulation and extracting the free energy surface by reweighting. The other exercises in this tutorial have shown us that when we do this, it is essential to:</p>
<ul>
<li>Quote error bars on the estimates of the free energy we obtain as the values we get from our simulation will be random variables. Quoting error bars is thus essential in terms of making our results reproducible.</li>
<li>Calculate weighted averages using the ideas discussed in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-8">Exercise 8: Weighted averages</a> as we need to account for the effect the bias has on the sampling of phase space.</li>
<li>Use the block averaging method discussed in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-4">Exercise 4: Calculating block averages</a> to obtain multiple estimates for the free energy. Notice that we need to use block averaging because, as discussed in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-7">Exercise 7: Dealing with correlated data</a>, there are correlations between the CV values the system visits during the trajectory.</li>
</ul>
<p>As these three issues have been the focus of this tutorial, we focus on them in the exercise that follows. The theory behind the metadynamics method that we are using is discussed in detail in <a class="el" href="masterclass-21-4.html">PLUMED Masterclass 21.4: Metadynamics</a> if you are interested. <br  />
</p>
<p>We will study a system of 7 Lennard Jones atoms in two dimensions in what follows using the MD code <b>simplemd</b> that is part of PLUMED. You can run this code by issuing the command:</p>
<pre class="fragment">plumed simplemd &lt; in
</pre><p>where <b>in</b> here is the input file from the GitHub repository for this tutorial. This input file instructs PLUMED to perform 200000 steps of MD at a temperature of \(k_B T = 0.1 \epsilon\) starting from the configuration in input.xyz. <br  />
 The timestep in this simulation is 0.005 \(\sqrt{\epsilon}{m\sigma^2}\) and the temperature is kept fixed using a Langevin thermostat with a relaxation time of \(0.1 \sqrt{\epsilon}{m\sigma^2}\). Trajectory frames are output every 1000 MD steps to a file called trajectory.xyz. Notice also that to run the calculation above you need to provide a PLUMED input file called plumed.dat. <br  />
</p>
<p>We want to investigate transitions between the four structures of Lennard Jones 7 that are shown below using metadynamics.</p>
<p><a class="anchor" id="masterclass-21-1-4-lj7-minima"></a></p><div class="image">
<img src="Lyon-lj7-minima.png" alt=""/>
<div class="caption">
The four energetic minima in the energy landscape for two-dimensional Lennard Jones 7.</div></div>
<p>However, when we run the metadynamics, we will often find that the cluster evaporates and the seven atoms separate. To prevent this, we will thus add restraints to prevent the cluster from evaporating. The particular restraint we are going to use will prevent all the atoms from moving more than \(2\sigma\) from the centre of mass of the cluster. As the masses of all the atoms in the cluster are the same, we can compute the position of the centre of mass using: </p><p class="formulaDsp">
\[ \mathbf{x}_\textrm{com} = \frac{1}{N} \sum_{i=1}^N \mathbf{x}_i \]
</p>
<p> where \(\mathbf{x}_i\) is the position of the atom with the index \(i\). The distance between the atom with index \(i\) and the position of this centre of mass, \(d_i\), can be computed using Pythagoras' theorem. These distances are then restrained by using the following potential: </p><p class="formulaDsp">
\[ V(d_i) = \begin{cases} 100*(d_i-2.0)^2 &amp; \textrm{if} \quad d_i &gt; 2 \\ 0 &amp; \textrm{otherwise} \end{cases} \]
</p>
<p> as you can see, this potential does not affect the dynamics when these distances are less than 2 \(\epsilon\). If an atom is more than 2 \(\epsilon\) from the centre of mass, however, this potential will drive it back towards the centre of mass.</p>
<p>A metadynamics bias will be used to force the system to move between the four configurations shown in <a class="el" href="masterclass-21-2.html#masterclass-21-1-4-lj7-minima">masterclass-21-1-4-lj7-minima</a>. This bias will act on the second and third central moments of the distribution of coordination numbers. The nth central moment of a set of numbers, \(\{X_i\}\) can be calculated using: </p><p class="formulaDsp">
\[ \mu^n = \frac{1}{N} \sum_{i=1}^N ( X_i - \langle X \rangle )^n \qquad \textrm{where} \qquad \langle X \rangle = \frac{1}{N} \sum_{i=1}^N X_i \]
</p>
<p> Furthermore, we can compute the coordination number of our Lennard Jones atoms using: </p><p class="formulaDsp">
\[ c_i = \sum_{i \ne j } \frac{1 - \left(\frac{r_{ij}}{1.5}\right)^8}{1 - \left(\frac{r_{ij}}{1.5}\right)^{16} } \]
</p>
<p> where \(r_{ij}\) is the distance between atom \(i\) and atom \(j\). With all this information in mind the following cell contains a skeleton input file for PLUMED that gets it to perform metadynamics using the second and third central moments of the distribution of coordination numbers as a CV.</p>

<div style="width: 90%; float:left" id="value_details_eg7"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># this optional command tells VIM that this is a PLUMED file and to colour the text accordingly</span>
<span style="color:blue"># vim: ft=plumed</span>
<span style="color:blue"># This tells PLUMED we are using Lennard Jones units</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_u_n_i_t_s.html" style="color:green">UNITS</a> <div class="tooltip">NATURAL<div class="right">( default=off ) use natural units <i></i></div></div> <span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate the position of the centre of mass. We can then refer to this position later in the input using the label com.</span>
<b name="eg7com" onclick='showPath("eg7","eg7com")'>com: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_o_m.html" style="color:green">COM</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7com"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the first atom</span>
<b name="eg7d1" onclick='showPath("eg7","eg7d1")'>d1: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7d1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg7d1">d1</b> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the second atom</span>
<b name="eg7d2" onclick='showPath("eg7","eg7d2")'>d2: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7d2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the third atom</span>
<b name="eg7d3" onclick='showPath("eg7","eg7d3")'>d3: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7d3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the fourth atom</span>
<b name="eg7d4" onclick='showPath("eg7","eg7d4")'>d4: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7d4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the fifth atom</span>
<b name="eg7d5" onclick='showPath("eg7","eg7d5")'>d5: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7d5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the sixth atom</span>
<b name="eg7d6" onclick='showPath("eg7","eg7d6")'>d6: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7d6"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Add the restraint on the distance between com and the seventh atom</span>
<b name="eg7d7" onclick='showPath("eg7","eg7d7")'>d7: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7d7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_u_p_p_e_r__w_a_l_l_s.html" style="color:green">UPPER_WALLS</a> <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate the collective variables</span>
<b name="eg7c1" onclick='showPath("eg7","eg7c1")'>c1: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n_n_u_m_b_e_r.html" style="color:green">COORDINATIONNUMBER</a> <div class="tooltip">SPECIES<div class="right">this keyword is used for colvars such as coordination number. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">MOMENTS<div class="right">calculate the moments of the distribution of collective variables. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">SWITCH<div class="right">This keyword is used if you want to employ an alternative to the continuous switching
function defined above. <i></i></div></div>={RATIONAL __FILL__ }  <span style="display:none;" id="eg7c1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Do metadynamics</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_m_e_t_a_d.html" style="color:green">METAD</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">HEIGHT<div class="right">the heights of the Gaussian hills. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
the frequency for hill addition <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">SIGMA<div class="right"><b>compulsory keyword </b>
the widths of the Gaussian hills <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">GRID_MIN<div class="right">the lower bounds for the grid <i></i></div></div>=-1.5,-1.5 <div class="tooltip">GRID_MAX<div class="right">the upper bounds for the grid <i></i></div></div>=2.5,2.5 <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=500,500 <div class="tooltip">BIASFACTOR<div class="right">use well tempered metadynamics and use this bias factor. <i></i></div></div>=5 <span style="display:none;" id="eg7"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p><b> Copy this input to file called plumed.dat and modify it so that it instructs PLUMED to add Gaussian kernels with a bandwidth of 0.1 in both the second and third moment of the distribution of coordination numbers and a height of 0.05 \(\epsilon\) every 500 MD steps. You can then use this input together with the input.xyz, and in files, you obtained from the GitHub repository to generate a metadynamics trajectory at \(k_B T = 0.1 \epsilon\) by running the command: </b></p>
<pre class="fragment">plumed simplemd &lt; in
</pre><p>Once you have run the metadynamics calculations, you can post-process the output trajectory using <b> driver </b> to extract the free energy by <a href="https://www.notion.so/Weighted-histograms-546d0b3837ce43a3b9de0dcf7a741353">reweighting</a>. Notice that to do block averaging, you will need to extract multiple estimates for the (weighted) histogram. You should thus use the following input file to extract estimates of the histogram:</p>

<div style="width: 90%; float:left" id="value_details_eg8"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># this optional command tells VIM that this is a PLUMED file and to colour the text accordingly</span>
<span style="color:blue"># vim: ft=plumed</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_u_n_i_t_s.html" style="color:green">UNITS</a> <div class="tooltip">NATURAL<div class="right">( default=off ) use natural units <i></i></div></div> <span style="display:none;" id="eg8"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># We can delete the parts of the input that specified the walls and disregard these in our analysis</span>
<span style="color:blue"># It is OK to do this as we are only interested in the value of the free energy in parts of phase space</span>
<span style="color:blue"># where the bias due to these walls is not acting.</span>
<b name="eg8c1" onclick='showPath("eg8","eg8c1")'>c1: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_o_o_r_d_i_n_a_t_i_o_n_n_u_m_b_e_r.html" style="color:green">COORDINATIONNUMBER</a> <div class="tooltip">SPECIES<div class="right">this keyword is used for colvars such as coordination number. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">MOMENTS<div class="right">calculate the moments of the distribution of collective variables. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">SWITCH<div class="right">This keyword is used if you want to employ an alternative to the continuous switching
function defined above. <i></i></div></div>={RATIONAL __FILL__}  <span style="display:none;" id="eg8c1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># The metadynamics bias is restarted here so we consider the final bias as a static bias in our calculations</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_m_e_t_a_d.html" style="color:green">METAD</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">HEIGHT<div class="right">the heights of the Gaussian hills. <i></i></div></div>=0.05 <div class="tooltip">PACE<div class="right"><b>compulsory keyword </b>
the frequency for hill addition <i></i></div></div>=50000000 <div class="tooltip">SIGMA<div class="right"><b>compulsory keyword </b>
the widths of the Gaussian hills <i></i></div></div>=0.1,0.1 <div class="tooltip">GRID_MIN<div class="right">the lower bounds for the grid <i></i></div></div>=-1.5,-1.5 <div class="tooltip">GRID_MAX<div class="right">the upper bounds for the grid <i></i></div></div>=2.5,2.5 <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=500,500 <div class="tooltip">TEMP<div class="right">the system temperature - this is only needed if you are doing well-tempered metadynamics
<i></i></div></div>=0.1 <div class="tooltip">BIASFACTOR<div class="right">use well tempered metadynamics and use this bias factor. <i></i></div></div>=5 <div class="tooltip">RESTART<div class="right">allows per-action setting of restart (YES/NO/AUTO) <i></i></div></div>=YES <span style="display:none;" id="eg8"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># This adjusts the weights of the sampled configurations and thereby accounts for the effect of the bias potential</span>
<b name="eg8rw" onclick='showPath("eg8","eg8rw")'>rw: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_w_e_i_g_h_t__b_i_a_s.html" style="color:green">REWEIGHT_BIAS</a> <div class="tooltip">TEMP<div class="right">the system temperature. <i></i></div></div>=0.1 <span style="display:none;" id="eg8rw"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># Calculate the histogram and output it to a file</span>
<b name="eg8hh" onclick='showPath("eg8","eg8hh")'>hh: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg8c1">c1.*</b> <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=-1.5,-1.5 <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=2.5,2.5 <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=200,200 <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.02,0.02 <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">CLEAR<div class="right"><b>compulsory keyword ( default=0 )</b>
the frequency with which to clear all the accumulated data. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">NORMALIZATION<div class="right"><b>compulsory keyword ( default=ndata )</b>
This controls how the data is normalized it can be set equal to true, false or ndata.
<i></i></div></div>=true <span style="display:none;" id="eg8hh"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<b name="eg8hh">hh</b> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=my_histogram.dat <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=0 )</b>
the frequency with which the grid should be output to the file. <i></i></div></div>=2500 <span style="display:none;" id="eg8"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Once you have filled in the blanks in this input, you can then run the calculation by using the command:</p>
<pre class="fragment">&gt; plumed driver --ixyz trajectory.xyz  --initial-step 1
</pre><p>You must make sure that the HILLS file that was output by your metadynamics simulation is available in the directory where you run the above command.</p>
<p>For the rest of the exercise, you are on your own. You must use what you have learned in the other parts of the tutorial to generate plots similar to those shown below. The leftmost plot here is the free energy surface computed by taking the (weighted) average of the blocks, the right panel shows the size of the error bar on the free energy at each point of the free energy surface. <br  />
</p>
<p><a class="anchor" id="masterclass-21-2-figp"></a></p><div class="image">
<img src="masterclass-21-2-fes_errors.png" alt=""/>
<div class="caption">
The estimate of the free energy for the Lennard Jones system (left panel) and the errors on these estimate of the free energy.</div></div>
<p>Notice that the data is correlated here so you should investigate how the error size depends on the lengths of the blocks as was discussed in <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-7">Exercise 7: Dealing with correlated data</a>. When I did this analysis I found that the error does not have a strong dependence on the size of the blocks.</p>
<p><a class="anchor" id="masterclass-21-2-figp2"></a></p><div class="image">
<img src="masterclass-21-2-fes_error_blocks.png" alt=""/>
<div class="caption">
The dependence of the average error in the free energy on the size of the blocks used for the block averaging.</div></div>
<p>Finally, if you are struggling to plot the 2D free energy surface, you can generate free energy as a function of one CV only using the ideas from earlier exercises.</p>
<p><em> Hint: You are now calculating weighted averages so you will need to use the code you wrote for <a class="el" href="masterclass-21-2.html#masterclass-21-2-ex-8">Exercise 8: Weighted averages</a> to merge the histograms </em></p>
<h1><a class="anchor" id="masterclass-21-2-fr"></a>
Further reading</h1>
<p>If you want to know more about good practise using PLUMED you can read <a href="https://arxiv.org/abs/1812.08213">https://arxiv.org/abs/1812.08213</a>. We would also recommend learning about kernel density estimation, which will often give you smoother histograms. You can start learning about kernel density estimation by reading <a href="https://en.wikipedia.org/wiki/Kernel_density_estimation">https://en.wikipedia.org/wiki/Kernel_density_estimation</a>. My full sets of notes are available here:</p>
<ul>
<li><a href="https://www.notion.so/940bd09c5be343888244beb21ed4a166?v=6bb0bd98d8fc47a081164069121ee396">Probability theory notes</a></li>
<li><a href="https://www.notion.so/365db6742a81483ba82d27a3c9133eba?v=7859a0ae344042eab8ff6dab16533224">Thermodynamics notes</a></li>
<li><a href="https://www.notion.so/4bc79cd418674ffcb90b6730dbf94b22?v=c6499c1314624bb38869504d0111a024">Statistical Mechanics notes</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
