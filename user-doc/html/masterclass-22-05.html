<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: PLUMED Masterclass 22.5: Machine learning collective variables with Pytorch</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.9.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('masterclass-22-05.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">PLUMED Masterclass 22.5: Machine learning collective variables with Pytorch </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section author"><dt>Authors</dt><dd>Luigi Bonati </dd></dl>
<dl class="section date"><dt>Date</dt><dd>March 28, 2022</dd></dl>
<h1><a class="anchor" id="masterclass-22-05-aims"></a>
Aims</h1>
<p>This Masterclass describes how to design data-driven collective variables using machine learning (ML) methods.</p>
<h1><a class="anchor" id="masterclass-22-05-obj"></a>
Objectives</h1>
<p>Once this Masterclass is completed, you will know how to:</p>
<ul>
<li>Design data-driven CVs in Python using Pytorch</li>
<li>Deploy them in PLUMED via the <a class="el" href="_p_y_t_o_r_c_h__m_o_d_e_l.html">PYTORCH_MODEL</a> interface</li>
</ul>
<h1><a class="anchor" id="masterclass-22-05-prereq"></a>
Prerequisites</h1>
<p>We assume that you are familiar with PLUMED and enhanced sampling calculations. If you are not, the 2021 PLUMED Masterclass is a great place to start. We will also use <a class="el" href="_o_p_e_s.html">OPES (On-the-fly Probability Enhanced Sampling)</a> to enhance sampling, which has been covered on the <a class="el" href="masterclass-22-03.html">PLUMED Masterclass 22.3: OPES method</a>.</p>
<p>Furthermore, Python knowledge is required for this masterclass.</p>
<h1><a class="anchor" id="masterclass-22-05-theory"></a>
Overview</h1>
<p>The identification of suitable collective variables (CVs) is crucial for the success of several enhanced sampling methods. Typically, the quest for CVs has been driven by physical intuition, however, the complexity of the systems that can be simulated nowadays calls for new approaches. For this reason, here we want to learn the CVs directly from molecular dynamics data. As in any machine learning approach, the three key ingredients will be (1) the data, (2) the model, and (3) the objective function. We note that these are tightly connected to each other. Indeed, depending on the kind of data that is available we can ask different questions. Furthermore, the ability to answer such questions (as well as to interpret the results) will depend on the choice of appropriate models.</p>
<p>Broadly speaking, the CVs should represent the collective atomic movement as the system translocates from one metastable state to another. As a general requirement, CVs should be continuous and differentiable functions of the atomic positions able to (1) distinguish the different states and (2) be connected to the slow modes of the system. However, this results in a chicken and egg problem: if we have reactive trajectories that already explored the relevant phase space we might analyze such simulations and extract good CVs. But more often than not, for obtaining such reactive simulations we already need good CVs. Here we describe two possible ways out of this chicken-and-egg situation, which reflects two scenarios that in the practice occur very often:</p>
<p>(1) Only the metastable states are known. These could be for instance the reactant and product of a chemical reaction, crystalline and liquid configurations of a material, the bound and unbound states of a ligand into a protein, etc... Given this limited data, we can guess the CVs by optimizing variables with a classification criterion <a class="el" href="citelist.html#CITEREF_bonati2020data">[18]</a>. This consists of enforcing only the first CV requirement stated above. Of course, one should not expect this to work as well as if one could add dynamic information on the transition paths, but it should be seen as a way to make the best out of limited knowledge. Very often the only information available is what the states of interest are, and so it is necessary to develop methods that can construct approximate CVs from this information.</p>
<p>(2) We have an enhanced sampling simulation in which we have biased some CV, but with suboptimal results. Instead of proceeding by trial and error by changing the CVs until we find the right one(s), we can analyze such simulations and identify the slow degrees of freedom. If we can express them in a functional form and subsequently bias them we will be able to significantly improve sampling quality <a class="el" href="citelist.html#CITEREF_bonati2021deep">[19]</a>.</p>
<h1><a class="anchor" id="masterclass-22-05-install"></a>
Software and data</h1>
<p>The data needed to complete the exercises of this Masterclass can be found on <a href="https://github.com/luigibonati/masterclass-plumed/">GitHub</a>. To complete the exercises, we will go through a set of <b>Jupyter notebooks</b>, from which all the simulations can be performed and analyzed.</p>
<p>Participants of the masterclass will receive a link to a project on <a href="https://deepnote.com/">DeepNote</a>, a collaborative data science platform. There you will find all the necessary software already installed and you will be able to go through the notebook and perform MD simulations.</p>
<p>If instead you want to run the exercises on your computer you can follow the instructions available on <a href="https://github.com/luigibonati/masterclass-plumed/blob/main/INSTALL.md">GitHub</a>. In particular, you will need to use the development version of PLUMED. Furthermore, you will need to download LibTorch and configure PLUMED against it, as well as enable the PYTORCH and OPES modules. To configure PLUMED with Pytorch you can follow the instructions in the <a class="el" href="_p_y_t_o_r_c_h.html">PYTORCH (Machine Learning Collective Variables)</a> page. To run the simulations we will use GROMACS 2020.6 patched with PLUMED.</p>
<h2><a class="anchor" id="masterclass-22-05-training"></a>
Training CVs with Pytorch</h2>
<p>In this tutorial, we will use <a href="https://mlcvs.readthedocs.io/en/latest/">mlcvs</a>, a Python-based package designed for building data-driven collective variables for enhanced sampling simulations. In <code>mlcvs</code> we have implemented different kinds of data-driven CVs proposed in the literature, including Deep-LDA <a class="el" href="citelist.html#CITEREF_bonati2020data">[18]</a> and Deep-TICA <a class="el" href="citelist.html#CITEREF_bonati2021deep">[19]</a> which we describe in this masterclass.</p>
<h2><a class="anchor" id="masterclass-22-05-deploy"></a>
Using the CVs in PLUMED</h2>
<p>Once the models have been trained on the data, we can export them using the jit (just in time) compiler of Pytorch. This creates a Python-independent model, which can be loaded in PLUMED using Pytorch C++ APIs (LibTorch). Of particular relevance is that we can exploit the automatic differentiation feature of Pytorch to compute derivatives of the model with respect to the inputs. Note that in this way we can load the models exported from <code>mlcvs</code> as well as any other function built using Pytorch methods and serialized with jit.</p>
<p>A typical PLUMED input might be the following, in which we first calculate some descriptors and feed them as inputs of the model. </p>
<div style="width: 90%; float:left" id="value_details_eg1"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-passing-green.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue">#SETTINGS AUXFILE=regtest/pytorch/rt-pytorch_model_2d/torch_model.ptc</span>
<b name="eg1phi" onclick='showPath("eg1","eg1phi")'>phi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=5,7,9,15 <span style="display:none;" id="eg1phi">The TORSION action with label <b>phi</b> calculates a single scalar value</span>
<b name="eg1psi" onclick='showPath("eg1","eg1psi")'>psi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=7,9,15,17 <span style="display:none;" id="eg1psi">The TORSION action with label <b>psi</b> calculates a single scalar value</span>
<b name="eg1model" onclick='showPath("eg1","eg1model")'>model: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_p_y_t_o_r_c_h__m_o_d_e_l.html" style="color:green">PYTORCH_MODEL</a> <div class="tooltip">FILE<div class="right">Filename of the PyTorch compiled model <i></i></div></div>=torch_model.ptc <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg1phi">phi</b>,<b name="eg1psi">psi</b> <span style="display:none;" id="eg1model">The PYTORCH_MODEL action with label <b>model</b> calculates the following quantities:
<table  align="center" frame="void" width="95%%" cellpadding="5%%">
<tr><td width="5%%"><b> Quantity </b>  </td><td><b> Description </b> </td></tr>
<tr><td width="5%%">model.node-0</td><td>Model outputs  This is the 0th of these quantities</td></tr>
<tr><td width="5%%">model.node-1</td><td>Model outputs  This is the 1th of these quantities</td></tr>
</table>
</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=COLVAR <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg1model">model.node-0</b>,<b name="eg1model">model.node-1</b> <span style="display:none;" id="eg1">The PRINT action with label <b></b></span>
</pre>
<h1><a class="anchor" id="masterclass-22-05-ex"></a>
Exercises</h1>
<p>The exercises are presented in the Jupyter notebooks, from which all the simulations can be performed and analyzed. For this reason, this page only presents a high level overview of the contents of the notebooks.</p>
<h2><a class="anchor" id="masterclass-22-05-ex-system"></a>
Toy system: alanine dipeptide</h2>
<p>As done in some previous masterclass, we will play with a toy system, the small alanine dipeptide molecule in a vacuum (ala2). This has the advantage of being a well-known system and it is cheap to simulate. The typical use case is to test enhanced sampling methods using as CVs the torsional angle \(\phi\) and \(\psi\). Since the former is an almost ideal CV for describing the transition between its two metastable states, this will typically result in a very efficient sampling. Here we want to approach this problem in a more blind way and try to design efficient CVs with as little knowledge as possible, learning the CVs directly from the output of molecular dynamics simulations. <br  />
</p>
<p>In both exercises, we will characterize the molecule with a general set of physical descriptors, which are the interatomic distances between heavy atoms. The reason for not working directly with atomic positions is twofold: on one hand, invariant CVs can be easily obtained under the relevant symmetries, while on the other, we can use different kind of descriptors to focus the sampling on the relevant processes.</p>
<h2><a class="anchor" id="masterclass-22-05-ex-1"></a>
Tutorial 1: `Collective variables from equilibrium fluctuations</h2>
<p>You can find the first tutorial in the jupyter notebook <code>tutorial1_DeepLDA.ipynb</code>. In this exercise, we will design the CVs starting only from a realization of the metastable states. The main steps will be the following:</p>
<ol type="1">
<li>Perform short unbiased MD simulations in the metastable states and evaluate a set of physical descriptors (e.g. interatomic distances between heavy atoms)</li>
<li>We train a neural-network based CV to discriminate between the states, using Fisher's discriminant as the objective function (DeepLDA)</li>
<li>Finally, we apply a bias potential to enhance the fluctuations of the DeepLDA CV and drive the system back and forth between the two states.</li>
</ol>
<h2><a class="anchor" id="masterclass-22-05-ex-2"></a>
Tutorial 2: Collective variables as slow modes of biased simulations</h2>
<p>In the second exercise, which you can find in the notebook <code>tutorial2_DeepTICA.ipynb</code> , we will extract the CVs from biased simulations. As before, we will go through three main steps:</p>
<ol type="1">
<li>Perform an enhanced sampling calculation using some approximate CVs as well as generalized ensembles simulations (e.g. multicanonical).</li>
<li>Use the trajectory to train a neural-network based CV to find the maximally autocorrelated modes, which correspond to the slowest degrees of freedom (DeepTICA)</li>
<li>Bias these slow degrees of freedom to improve sampling </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
