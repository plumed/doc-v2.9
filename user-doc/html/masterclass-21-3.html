<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: PLUMED Masterclass 21.3: Umbrella sampling</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.9.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('masterclass-21-3.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">PLUMED Masterclass 21.3: Umbrella sampling </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section author"><dt>Authors</dt><dd>Giovanni Bussi </dd></dl>
<dl class="section date"><dt>Date</dt><dd>February 15, 2021</dd></dl>
<h1><a class="anchor" id="masterclass-21-3-aims"></a>
Aims</h1>
<p>In this Masterclass, we will discuss how to perform and analyze umbrella sampling simulations. We will learn how to introduce a bias potential with PLUMED, how to compute free energy landscapes, and how to reweight the resulting ensembles. We will also understand how to compute statistical errors on the computed quantities.</p>
<h1><a class="anchor" id="masterclass-21-3-lo"></a>
Objectives</h1>
<p>Once you have completed this Masterclass you will be able to:</p>
<ul>
<li>Use PLUMED to run simulations using static bias potentials with different functional forms.</li>
<li>Use WHAM to combine multiple simulations performed with different bias potentials.</li>
<li>Reweight the resulting ensembles so as to obtain the free-energy profile as a function of a different variable.</li>
<li>Calculate error bars on free energies and populations.</li>
</ul>
<h1><a class="anchor" id="masterclass-21-3-install"></a>
Setting up PLUMED</h1>
<p>If you have not yet set up PLUMED, you can find information about installing it in the section <a class="el" href="masterclass-21-1.html#masterclass-21-1-install">Setting up the software</a> of <a class="el" href="masterclass-21-1.html">PLUMED Masterclass 21.1: PLUMED syntax and analysis</a>.</p>
<p>Once you have installed PLUMED, you will need to install GROMACS as well. In particular, you will need a special version of GROMACS that has been patched with PLUMED. You can obtain it using conda with the following command</p>
<pre class="fragment">conda install --strict-channel-priority -c plumed/label/masterclass -c conda-forge gromacs
</pre><p>The <code>--strict-channel-priority</code> might be necessary in case your conda install is configured to download packages from the <code>bioconda</code> channel. Indeed, <code>bioconda</code> contains a version of GROMACS that is <b>not</b> patched with PLUMED and would thus not work here.</p>
<p>On Linux, the command above should install the following packages:</p>
<pre class="fragment">  gromacs            plumed/label/masterclass/linux-64::gromacs-2019.6-h3fd9d12_0
  libclang           conda-forge/linux-64::libclang-11.0.1-default_ha53f305_1
  libevent           conda-forge/linux-64::libevent-2.1.10-hcdb4288_3
  libhwloc           conda-forge/linux-64::libhwloc-1.11.13-h3c4fd83_0
  libllvm11          conda-forge/linux-64::libllvm11-11.0.1-hf817b99_0
  libpq              conda-forge/linux-64::libpq-12.3-h255efa7_3
  [ etc ... ]
</pre><p>The exact versions might be different. Notice however that GROMACS comes from the <code>plumed/label/masterclass</code> channel, whereas the required libraries come from the <code>conda-forge</code> channel. To be sure the installed GROMACS is patched with PLUMED, try the following shell command:</p>
<pre class="fragment">gmx mdrun -h 2&gt; /dev/null | grep -q plumed &amp;&amp; echo ok
</pre><p>It should print <code>ok</code>.</p>
<p>Please ensure that you have setup PLUMED and GROMACS on your machine before starting the exercises. Also notice that in order to obtain good performances it is better to compile GROMACS from source on the machine you are running your simulations. You can find out in the PLUMED documention how to patch GROMACS with PLUMED so as to be able to install it from source. For this tutorial, the conda precompiled binaries will be sufficient.</p>
<h1><a class="anchor" id="masterclass-21-3-resources"></a>
Resources</h1>
<p>The data needed to execute the exercises of this Masterclass can be found on <a href="https://github.com/plumed/masterclass-21-3">GitHub</a>. You can clone this repository locally on your machine using the following command:</p>
<pre class="fragment">git clone https://github.com/plumed/masterclass-21-3.git
</pre><p>The data you need is in the folder called <code>data</code>. You will find the following files in that folder:</p>
<ul>
<li><code>topolA.tpr</code>: an input file that can be used to run a GROMACS simulation of alanine dipeptide starting from one of the two main free-energy minima</li>
<li><code>topolB.tpr</code>: same as <code>topolA.tpr</code>, but starting from the other minimum.</li>
<li><code>wham.py</code>: a python script that can be used to perform binless WHAM analysis</li>
</ul>
<p>Notice that PLUMED input files have not been provided in the GitHub repository. You must prepare these input files yourself using the templates below.</p>
<p>We would recommend that you run each exercise in separate sub-directories inside the root directory <code>masterclass-21-3</code>.</p>
<dl class="section note"><dt>Note</dt><dd>All the exercises were tested with PLUMED version 2.7.0 and GROMACS 2019.6</dd></dl>
<h1><a class="anchor" id="masterclass-21-3-ex"></a>
Exercises</h1>
<p>Throughout this tutorial we will run simulations of alanine dipeptide in vacuum using GROMACS and PLUMED. Whereas this system is too simple to be considered a proper benchmark for enhanced sampling methods, it is complex enough to be used in learning them. Some of the commands below are specific for GROMACS, but all the PLUMED input files are compatible with other MD engines as well.</p>
<h2><a class="anchor" id="masterclass-21-3-ex-1"></a>
Exercise 1: Running an unbiased simulation with PLUMED</h2>
<p>In <a class="el" href="masterclass-21-1.html">PLUMED Masterclass 21.1: PLUMED syntax and analysis</a> we learned how to analyze trajectories a posteriori. One of the nice features of PLUMED is that the very same analysis can be done on the fly. In other words, you might compute your collective variables while GROMACS is running instead of waiting for the simulation to end. This can could be convenient if you want to run a large number of simulations, you already know what to compute, and you do not want to use too much disk space.</p>
<p>To run a simulation with GROMACS you have to type this command in the shell:</p>
<pre class="fragment">gmx mdrun -plumed plumed.dat -s topolA.tpr -nsteps 200000 -x traj_unbiased.xtc
</pre><p>Notice that the file <code>topolA.tpr</code> contains all the relevant information (simulation parameters, initial conditions, etc.). In this tutorial we will just need to play with the number of steps (200000 in the example above) and we will tune the name of the trajectory saved by GROMACS (traj_unbiased.xtc in the example above).</p>
<p>Also consider that GROMACS and PLUMED are not going to delete your files but are taking backups when you try to overwrite them. GROMCAS backup files start with <code>#</code>, whereas PLUMED backup files start with <code>bck.</code>. Both GROMACS and PLUMED will complain if you try to create too many backups of the same file. It is thus recommended to regularly clean your directory with a command such as <code>rm -f \#* bck.*</code></p>
<p>The command above will only succeed if a file named <code>plumed.dat</code> exists in the current directory. We know already how to create such file from <a class="el" href="masterclass-21-1.html">PLUMED Masterclass 21.1: PLUMED syntax and analysis</a>. In <a class="el" href="masterclass-21-2.html">PLUMED Masterclass 21.2: Statistical errors in MD</a> we also learned how to compute histograms. You should be thus able to complete the template below and put it in a file named <code>plumed.dat</code>. </p>
<div style="width: 90%; float:left" id="value_details_eg1"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># vim:ft=plumed</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_m_o_l_i_n_f_o.html" style="color:green">MOLINFO</a> <div class="tooltip">STRUCTURE<div class="right"><b>compulsory keyword </b>
a file in pdb format containing a reference structure. <i></i></div></div>=reference.pdb <span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg1phi" onclick='showPath("eg1","eg1phi")'>phi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="color:blue"># use MOLINFO shortcuts to identify the phi angle of the second residue </span><span style="display:none;" id="eg1phi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg1psi" onclick='showPath("eg1","eg1psi")'>psi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="color:blue"># use MOLINFO shortcuts to identify the psi angle of the second residue </span><span style="display:none;" id="eg1psi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># use the command below to compute the histogram of phi</span>
<span style="color:blue"># we use a smooth kernel to produce a nicer graph here</span>
<span style="color:blue"># notice that when asking for numbers PLUMED is happy to accept strings such as "pi" meaning 3.14...</span>
<span style="color:blue"># also arithmetics is allowed (e.g. 2*pi could be used if necessary)</span>
<b name="eg1hhphi" onclick='showPath("eg1","eg1hhphi")'>hhphi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the data should be collected and added to the quantity being
averaged <i></i></div></div>=100 <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=-pi <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=600 <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.05 <span style="display:none;" id="eg1hhphi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg1ffphi" onclick='showPath("eg1","eg1ffphi")'>ffphi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_o_n_v_e_r_t__t_o__f_e_s.html" style="color:green">CONVERT_TO_FES</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the input grid you would like to use <i></i></div></div>=<b name="eg1hhphi">hhphi</b> <span style="color:blue"># no need to set TEMP here, PLUMED will obtain it from GROMACS </span><span style="display:none;" id="eg1ffphi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=fes_phi.dat <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=0 )</b>
the frequency with which the grid should be output to the file. <i></i></div></div>=200000 <span style="color:blue"># stride is needed here since PLUMED does not know when the simulation is over </span><span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># now add three more lines to compute and dump the free energy as a function of **psi** on a file names fes_psi.dat</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <span style="background-color:yellow">__FILL__</span><span style="color:blue"># use this command to write phi and psi on a file named colvar.dat, every 100 steps </span><span style="display:none;" id="eg1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>You can then monitor what happened during the simulation using the python script above. </p><div class="fragment"><div class="line"><span class="keyword">import</span> plumed</div>
<div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div>
<div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"> </div>
<div class="line"><span class="comment"># plot the time series of phi and psi</span></div>
<div class="line">colvar=plumed.read_as_pandas(<span class="stringliteral">&quot;colvar.dat&quot;</span>)</div>
<div class="line">plt.plot(colvar.time,colvar.phi,<span class="stringliteral">&quot;x&quot;</span>,label=<span class="stringliteral">&quot;phi&quot;</span>)</div>
<div class="line">plt.plot(colvar.time,colvar.psi,<span class="stringliteral">&quot;x&quot;</span>,label=<span class="stringliteral">&quot;psi&quot;</span>)</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;time&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$\phi$&quot;</span>)</div>
<div class="line">plt.legend()</div>
<div class="line">plt.show()</div>
<div class="line"> </div>
<div class="line"><span class="comment"># scatter plot with phi and psi</span></div>
<div class="line">plt.plot(colvar.phi,colvar.psi,<span class="stringliteral">&quot;x&quot;</span>)</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;$\phi$&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$\psi$&quot;</span>)</div>
<div class="line">plt.xlim((-np.pi,np.pi))</div>
<div class="line">plt.ylim((-np.pi,np.pi))</div>
<div class="line">plt.show()</div>
<div class="line"> </div>
<div class="line"><span class="comment"># FES as a function of phi</span></div>
<div class="line"><span class="comment"># we remove infinite and nans here</span></div>
<div class="line">fes_phi=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_phi&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_phi.phi,fes_phi.ffphi)</div>
<div class="line">plt.xlim((-np.pi,np.pi))</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;$\phi$&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$F(\phi)$&quot;</span>)</div>
<div class="line">plt.show()</div>
<div class="line"> </div>
<div class="line"><span class="comment"># FES as a function of psi</span></div>
<div class="line"><span class="comment"># we remove infinite and nans here</span></div>
<div class="line">fes_psi=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_psi&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_psi.psi,fes_psi.ffpsi)</div>
<div class="line">plt.xlim((-np.pi,np.pi))</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;$\psi$&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$F(\psi)$&quot;</span>)</div>
<div class="line">plt.show()</div>
</div><!-- fragment --><p>In this manner you will be able to see (a) the time series of \( \phi \) and \( \psi \), (b) which portion of the \((\phi,\psi)\) space has been explored (c) the free energy as a function of \( \phi \) and (d) the free energy as a function of \( \psi \). In particular, you should be able to identify two minima separated by a moderate barrier, and several transitions between these minima will be visible in the simulated time scale.</p>
<h2><a class="anchor" id="masterclass-21-3-ex-2"></a>
Exercise 2: Running biased simulations with PLUMED</h2>
<p>We are now ready to use PLUMED to perform the task it was originally designed for: biasing a simulation on the fly. We will first try to add simple bias potentials that change the balance between the two minima we have obtained in the previous exercise. Not particularly useful here since both minima were sampled anyways. However, it is instructive since we will be able to test the same type of analysis we did in <a class="el" href="masterclass-21-2.html">PLUMED Masterclass 21.2: Statistical errors in MD</a>. The two minima observed in the previous exercise are located at \( \phi \) approximately equal to -2.5 and -1.5, separated by a barrier located at \( \phi \) approximately equal to -2. We can predict that adding a bias potential in the form <code>-A*sin(x+2)</code>, with A positive and large enough, should favor the minimum at -1.5 at the expense of the other. We can try with A=10 using an input file like the following one: </p>
<div style="width: 90%; float:left" id="value_details_eg2"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># vim:ft=plumed</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="color:blue"># compute phi and psi here, as in the previous input file </span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># fill in with the required function (i.e. -10*sin(phi+2)):</span>
<b name="eg2f" onclick='showPath("eg2","eg2f")'>f: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_u_s_t_o_m.html" style="color:green">CUSTOM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=phi <div class="tooltip">FUNC<div class="right"><b>compulsory keyword </b>
the function you wish to evaluate <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">PERIODIC<div class="right"><b>compulsory keyword </b>
if the output of your function is periodic then you should specify the periodicity
of the function. <i></i></div></div>=NO <span style="display:none;" id="eg2f"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># this command allows to add a bias potential equal to f</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_b_i_a_s_v_a_l_u_e.html" style="color:green">BIASVALUE</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg2f">f</b> <span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># here you can paste the same HISTOGRAM/CONVERT_TO_FES/DUMPGRID commands that you used in</span>
<span style="color:blue"># the previous exercise. let's just write the results on different files</span>
<b name="eg2hhphi" onclick='showPath("eg2","eg2hhphi")'>hhphi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg2hhphi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2ffphi" onclick='showPath("eg2","eg2ffphi")'>ffphi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg2ffphi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=fes_phi_biased1.dat <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2hhpsi" onclick='showPath("eg2","eg2hhpsi")'>hhpsi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg2hhpsi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2ffpsi" onclick='showPath("eg2","eg2ffpsi")'>ffpsi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg2ffpsi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=fes_psi_biased1.dat <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2lw" onclick='showPath("eg2","eg2lw")'>lw: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_w_e_i_g_h_t__b_i_a_s.html" style="color:green">REWEIGHT_BIAS</a> <span style="display:none;" id="eg2lw"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># and here we do the same again, but this time using LOGWEIGHTS.</span>
<span style="color:blue"># these free energies will be printed on files fes_phi_biased1r.dat and</span>
<span style="color:blue"># fes_psi_biased1r.dat and will be reweighted so as to be unbiased</span>
<b name="eg2hhphir" onclick='showPath("eg2","eg2hhphir")'>hhphir: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <div class="tooltip">LOGWEIGHTS<div class="right"><b> could not find this keyword </b><i></i></div></div>=<b name="eg2lw">lw</b> <span style="display:none;" id="eg2hhphir"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2ffphir" onclick='showPath("eg2","eg2ffphir")'>ffphir: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg2ffphir"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=fes_phi_biased1r.dat <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2hhpsir" onclick='showPath("eg2","eg2hhpsir")'>hhpsir: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <div class="tooltip">LOGWEIGHTS<div class="right"><b> could not find this keyword </b><i></i></div></div>=<b name="eg2lw">lw</b> <span style="display:none;" id="eg2hhpsir"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg2ffpsir" onclick='showPath("eg2","eg2ffpsir")'>ffpsir: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/___f_i_l_l__.html" style="color:green">__FILL__</a> <span style="display:none;" id="eg2ffpsir"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=fes_psi_biased1r.dat <span style="background-color:yellow">__FILL__</span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <span style="background-color:yellow">__FILL__</span><span style="color:blue"># monitor what's happening, as before, writing on file plumed_colvar1.dat </span><span style="display:none;" id="eg2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p>Call this file <code>plumed_biased1.dat</code> and run the simulation using this command: </p><pre class="fragment">gmx mdrun -plumed plumed_biased1.dat -s topolA.tpr -nsteps 200000 -x traj_comp_biased1.xtc
</pre><p> Notice that we are storing the trajectory on a separate file. We will need both the unbiased and the biased trajectory later.</p>
<p>You can then monitor what happened during the simulation using these commands </p><div class="fragment"><div class="line">colvar=plumed.read_as_pandas(<span class="stringliteral">&quot;colvar_biased1.dat&quot;</span>)</div>
<div class="line">plt.plot(colvar.time,colvar.phi,<span class="stringliteral">&quot;x&quot;</span>,label=<span class="stringliteral">&quot;phi&quot;</span>)</div>
<div class="line">plt.plot(colvar.time,colvar.psi,<span class="stringliteral">&quot;x&quot;</span>,label=<span class="stringliteral">&quot;psi&quot;</span>)</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;time&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$\phi$&quot;</span>)</div>
<div class="line">plt.legend()</div>
<div class="line">plt.show()</div>
<div class="line"> </div>
<div class="line">plt.plot(colvar.phi,colvar.psi,<span class="stringliteral">&quot;x&quot;</span>)</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;$\phi$&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$\psi$&quot;</span>)</div>
<div class="line">plt.xlim((-np.pi,np.pi))</div>
<div class="line">plt.ylim((-np.pi,np.pi))</div>
<div class="line">plt.show()</div>
<div class="line"> </div>
<div class="line">fes_phi=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_phi.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_phi.phi,fes_phi.ffphi,label=<span class="stringliteral">&quot;original&quot;</span>)</div>
<div class="line">fes_phib=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_phi_biased1.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_phib.phi,fes_phib.ffphi,label=<span class="stringliteral">&quot;biased&quot;</span>)</div>
<div class="line">fes_phir=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_phi_biased1r.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_phir.phi,fes_phir.ffphir,label=<span class="stringliteral">&quot;reweighted&quot;</span>)</div>
<div class="line">plt.legend()</div>
<div class="line">plt.xlim((-np.pi,np.pi))</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;$\phi$&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$F(\phi)$&quot;</span>)</div>
<div class="line">plt.show()</div>
<div class="line"> </div>
<div class="line">fes_psi=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_psi.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_psi.psi,fes_psi.ffpsi,label=<span class="stringliteral">&quot;original&quot;</span>)</div>
<div class="line">fes_psib=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_psi_biased1.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_psib.psi,fes_psib.ffpsi,label=<span class="stringliteral">&quot;biased&quot;</span>)</div>
<div class="line">fes_psir=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_psi_biased1r.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_psir.psi,fes_psir.ffpsir,label=<span class="stringliteral">&quot;reweighted&quot;</span>)</div>
<div class="line">plt.legend()</div>
<div class="line">plt.xlim((-np.pi,np.pi))</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;$\psi$&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$F(\psi)$&quot;</span>)</div>
<div class="line">plt.show()</div>
</div><!-- fragment --><p>The free-energy plots here will include three lines: (a) the original one (as obtained from the previous exercise), (b) the one sampled in this second simulation, where the minimum at higher phi appears more stable, and (c) the reweighted free-energy from the second simulation, that should look closer to the original one. Notice that the relationship between plots (b) and (c) is straightforward when the analyzed variable is phi: the third line could have been obtained by just adding \( -10 \sin(x+2)\) to the second line. However, when analyzing psi the effect is less obvious.</p>
<h2><a class="anchor" id="masterclass-21-3-ex-3"></a>
Exercise 3: Combining statistics from biased and unbiased simulations</h2>
<p>We will now run a new simulation that is even more biased, and precisely choosing the prefactor A=20. This will favor even more the minimum at higher values of phi. Please prepare a <code>plumed_biased2.dat</code> input file that is identical to <code>plumed_biased1.dat</code> except for:</p><ul>
<li>it applies a bias -20*sin(phi+2)</li>
<li>all the written files are named with a <code>2</code> suffix (e.g. <code>fes_phi_biased2.dat</code>).</li>
</ul>
<p>The run the new simulation with the following command: </p><pre class="fragment">gmx mdrun -plumed plumed_biased2.dat -s topolA.tpr -nsteps 200000 -x traj_comp_biased2.xtc
</pre><p> You can once more analyze this simulation as you did for the previous one. You should notice that the peak at higher \( \phi \) is even more favored now.</p>
<p>We will now use WHAM to combine the three simulations we have done so far, namely: (a) unbiased (<code>traj_comp_unbiased.xtc</code>), (b) biased (<code>traj_comp_biased1.xtc</code>), and (c) more biased (<code>traj_comp_biased2.xtc</code>).</p>
<p>The first thing we have to do is to concatenate the three files: </p><pre class="fragment">gmx trjcat -cat -f traj_comp_unbiased.xtc traj_comp_biased1.xtc traj_comp_biased2.xtc -o traj_comp_cat.xtc
</pre><p> Notice that this new trajectory contains all the simulated frames, and we <b>do not</b> explicitly tracking from which of the simulation each frame originated. We then have to compute the bias that would have been felt in each of the three runs above by each of the frames in the concatenated trajectory. We could do this reusing the three plumed input files we used above, but it is perhaps clearer to do it with a single input file in this case. You can use an input like this one: </p>
<div style="width: 90%; float:left" id="value_details_eg3"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># vim:ft=plumed</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_m_o_l_i_n_f_o.html" style="color:green">MOLINFO</a> <div class="tooltip">STRUCTURE<div class="right"><b>compulsory keyword </b>
a file in pdb format containing a reference structure. <i></i></div></div>=reference.pdb <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3phi" onclick='showPath("eg3","eg3phi")'>phi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=@phi-2 <span style="display:none;" id="eg3phi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3psi" onclick='showPath("eg3","eg3psi")'>psi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=@psi-2 <span style="display:none;" id="eg3psi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># here we list the bias potentials that we used in the three simulations we want to combine</span>
<b name="eg3b0" onclick='showPath("eg3","eg3b0")'>b0: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_u_s_t_o_m.html" style="color:green">CUSTOM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg3phi">phi</b> <div class="tooltip">FUNC<div class="right"><b>compulsory keyword </b>
the function you wish to evaluate <i></i></div></div>=0.0 <div class="tooltip">PERIODIC<div class="right"><b>compulsory keyword </b>
if the output of your function is periodic then you should specify the periodicity
of the function. <i></i></div></div>=NO <span style="display:none;" id="eg3b0"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3b1" onclick='showPath("eg3","eg3b1")'>b1: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_u_s_t_o_m.html" style="color:green">CUSTOM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg3phi">phi</b> <div class="tooltip">FUNC<div class="right"><b>compulsory keyword </b>
the function you wish to evaluate <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">PERIODIC<div class="right"><b>compulsory keyword </b>
if the output of your function is periodic then you should specify the periodicity
of the function. <i></i></div></div>=NO <span style="color:blue"># fill here with the bias you used in the first biased simulation </span><span style="display:none;" id="eg3b1"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg3b2" onclick='showPath("eg3","eg3b2")'>b2: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_u_s_t_o_m.html" style="color:green">CUSTOM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg3phi">phi</b> <div class="tooltip">FUNC<div class="right"><b>compulsory keyword </b>
the function you wish to evaluate <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <div class="tooltip">PERIODIC<div class="right"><b>compulsory keyword </b>
if the output of your function is periodic then you should specify the periodicity
of the function. <i></i></div></div>=NO <span style="color:blue"># fill here with the bias you used in the second biased simulation </span><span style="display:none;" id="eg3b2"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg3phi">phi</b>,<b name="eg3psi">psi</b>,<b name="eg3b0">b0</b>,<b name="eg3b1">b1</b>,<b name="eg3b2">b2</b> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=biases.dat <span style="display:none;" id="eg3"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p> If you call it <code>plumed_wham.dat</code> you can then use the following command </p><pre class="fragment">plumed driver --plumed plumed_wham.dat --ixtc traj_comp_cat.xtc
</pre><p>We are now ready to use binless WHAM to compute the weights associated to the concatenated trajectory. This can be done with the following script </p><div class="fragment"><div class="line"><span class="keyword">import</span> wham</div>
<div class="line"><span class="comment"># this is to check that you actually imported the module located in this directory</span></div>
<div class="line"><span class="comment"># it should print /current/directory/wham.py</span></div>
<div class="line">print(wham.__file__)</div>
<div class="line"> </div>
<div class="line">bias=plumed.read_as_pandas(<span class="stringliteral">&quot;biases.dat&quot;</span>)</div>
<div class="line">kBT=300*8.314462618*0.001 <span class="comment"># use kJ/mol here</span></div>
<div class="line">w=wham.wham(np.stack((bias.b0,bias.b1,bias.b2)).T,T=kBT)</div>
<div class="line">print(w)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># you can then add a new column to the bias dataframe:</span></div>
<div class="line">print(bias)</div>
<div class="line">bias[<span class="stringliteral">&quot;logweights&quot;</span>]=w[<span class="stringliteral">&quot;logW&quot;</span>]</div>
<div class="line">print(bias)</div>
<div class="line"> </div>
<div class="line"><span class="comment"># and write it on disk</span></div>
<div class="line">plumed.write_pandas(bias,<span class="stringliteral">&quot;bias_wham.dat&quot;</span>)</div>
</div><!-- fragment --><p>With the procedure above we computed the weights that can be associated to the concatenated trajectory so as to recover an unbiased distribution. Notice that, although we did not explicitly enforced it, the weights only depends on the value of \( \phi \). This is because only \( \phi \) was biased here. Thus, if we plot the weight as a function of \( \phi \) all the points will collapse to a line. This will not happen if we plot the weights as a function of \( \psi \): </p><div class="fragment"><div class="line">plt.plot(bias.phi,bias.logweights,<span class="stringliteral">&quot;x&quot;</span>)</div>
<div class="line">plt.show()</div>
<div class="line">plt.plot(bias.psi,bias.logweights,<span class="stringliteral">&quot;x&quot;</span>)</div>
<div class="line">plt.show()</div>
</div><!-- fragment --><p>Also notice the form of the weights as a function of \( \phi \). This graph is telling us that points at larger \( \phi \) are weighted less. This makes sense, since in two simulations out of three we were biasing the ensemble so as to visit those points <b>more</b> frequently than in the Boltzmann ensemble. However, the curve is not exactly a sin function. This precise curve can only be obtained by solving self-consistently the WHAM equations.</p>
<p>We can then read the obtained weights and use them in an analysis similar to the one we have done above </p>
<div style="width: 90%; float:left" id="value_details_eg4"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># vim:ft=plumed</span>
<b name="eg4phi" onclick='showPath("eg4","eg4phi")'>phi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=bias_wham.dat <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg4phi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4psi" onclick='showPath("eg4","eg4psi")'>psi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=bias_wham.dat <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg4psi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4lw" onclick='showPath("eg4","eg4lw")'>lw: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_a_d.html" style="color:green">READ</a> <div class="tooltip">FILE<div class="right"><b>compulsory keyword </b>
the name of the file from which to read these quantities <i></i></div></div>=bias_wham.dat <div class="tooltip">VALUES<div class="right"><b>compulsory keyword </b>
the values to read from the file <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg4lw"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4hhphi" onclick='showPath("eg4","eg4hhphi")'>hhphi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg4phi">phi</b> <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=-pi <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=pi <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=600 <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.05 <span style="display:none;" id="eg4hhphi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4ffphi" onclick='showPath("eg4","eg4ffphi")'>ffphi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_o_n_v_e_r_t__t_o__f_e_s.html" style="color:green">CONVERT_TO_FES</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the input grid you would like to use <i></i></div></div>=<b name="eg4hhphi">hhphi</b> <span style="display:none;" id="eg4ffphi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<b name="eg4ffphi">ffphi</b> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=fes_phi_cat.dat <span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4hhpsi" onclick='showPath("eg4","eg4hhpsi")'>hhpsi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg4psi">psi</b> <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=-pi <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=pi <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=600 <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.05 <span style="display:none;" id="eg4hhpsi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4ffpsi" onclick='showPath("eg4","eg4ffpsi")'>ffpsi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_o_n_v_e_r_t__t_o__f_e_s.html" style="color:green">CONVERT_TO_FES</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the input grid you would like to use <i></i></div></div>=<b name="eg4hhpsi">hhpsi</b> <span style="display:none;" id="eg4ffpsi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<b name="eg4ffpsi">ffpsi</b> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=fes_psi_cat.dat <span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># we use a smooth kernel to produce a nicer graph here</span>
<b name="eg4hhphir" onclick='showPath("eg4","eg4hhphir")'>hhphir: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg4phi">phi</b> <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=-pi <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=pi <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=600 <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.05 <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<b name="eg4lw">lw</b> <span style="display:none;" id="eg4hhphir"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4ffphir" onclick='showPath("eg4","eg4ffphir")'>ffphir: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_o_n_v_e_r_t__t_o__f_e_s.html" style="color:green">CONVERT_TO_FES</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the input grid you would like to use <i></i></div></div>=<b name="eg4hhphir">hhphir</b> <span style="display:none;" id="eg4ffphir"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<b name="eg4ffphir">ffphir</b> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=fes_phi_catr.dat <span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4hhpsir" onclick='showPath("eg4","eg4hhpsir")'>hhpsir: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_h_i_s_t_o_g_r_a_m.html" style="color:green">HISTOGRAM</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg4psi">psi</b> <div class="tooltip">GRID_MIN<div class="right"><b>compulsory keyword </b>
the lower bounds for the grid <i></i></div></div>=-pi <div class="tooltip">GRID_MAX<div class="right"><b>compulsory keyword </b>
the upper bounds for the grid <i></i></div></div>=pi <div class="tooltip">GRID_BIN<div class="right">the number of bins for the grid <i></i></div></div>=600 <div class="tooltip">BANDWIDTH<div class="right"><b>compulsory keyword </b>
the bandwidths for kernel density estimation <i></i></div></div>=0.05 <div class="tooltip">LOGWEIGHTS<div class="right">list of actions that calculates log weights that should be used to weight configurations
when calculating averages <i></i></div></div>=<b name="eg4lw">lw</b> <span style="display:none;" id="eg4hhpsir"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg4ffpsir" onclick='showPath("eg4","eg4ffpsir")'>ffpsir: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_c_o_n_v_e_r_t__t_o__f_e_s.html" style="color:green">CONVERT_TO_FES</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the input grid you would like to use <i></i></div></div>=<b name="eg4hhpsir">hhpsir</b> <span style="display:none;" id="eg4ffpsir"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_d_u_m_p_g_r_i_d.html" style="color:green">DUMPGRID</a> <div class="tooltip">GRID<div class="right"><b>compulsory keyword </b>
the action that creates the grid you would like to output <i></i></div></div>=<b name="eg4ffpsir">ffpsir</b> <div class="tooltip">FILE<div class="right"><b>compulsory keyword ( default=density )</b>
the file on which to write the grid. <i></i></div></div>=fes_psi_catr.dat <span style="display:none;" id="eg4"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
</pre>
<p> Use the template above to produce a file names <code>plumed_wham.dat</code> and run the following command: </p><pre class="fragment">plumed driver --noatoms --plumed plumed_wham.dat --kt 2.4943387854
</pre><p>You can now show the result with the following script </p><div class="fragment"><div class="line">colvar=plumed.read_as_pandas(<span class="stringliteral">&quot;bias_wham.dat&quot;</span>)</div>
<div class="line">plt.plot(colvar.time,colvar.phi,<span class="stringliteral">&quot;x&quot;</span>,label=<span class="stringliteral">&quot;phi&quot;</span>)</div>
<div class="line">plt.plot(colvar.time,colvar.psi,<span class="stringliteral">&quot;x&quot;</span>,label=<span class="stringliteral">&quot;psi&quot;</span>)</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;time&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$\phi$&quot;</span>)</div>
<div class="line">plt.legend()</div>
<div class="line">plt.show()</div>
<div class="line"> </div>
<div class="line">plt.plot(colvar.phi,colvar.psi,<span class="stringliteral">&quot;x&quot;</span>)</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;$\phi$&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$\psi$&quot;</span>)</div>
<div class="line">plt.xlim((-np.pi,np.pi))</div>
<div class="line">plt.ylim((-np.pi,np.pi))</div>
<div class="line">plt.show()</div>
<div class="line"> </div>
<div class="line">fes_phi=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_phi.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_phi.phi,fes_phi.ffphi,label=<span class="stringliteral">&quot;original&quot;</span>)</div>
<div class="line">fes_phib=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_phi_cat.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_phib.phi,fes_phib.ffphi,label=<span class="stringliteral">&quot;biased&quot;</span>)</div>
<div class="line">fes_phir=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_phi_catr.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_phir.phi,fes_phir.ffphir,label=<span class="stringliteral">&quot;reweighted&quot;</span>)</div>
<div class="line">plt.legend()</div>
<div class="line">plt.xlim((-np.pi,np.pi))</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;$\phi$&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$F(\phi)$&quot;</span>)</div>
<div class="line">plt.show()</div>
<div class="line"> </div>
<div class="line">fes_psi=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_psi.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_psi.psi,fes_psi.ffpsi,label=<span class="stringliteral">&quot;original&quot;</span>)</div>
<div class="line">fes_psib=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_psi_cat.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_psib.psi,fes_psib.ffpsi,label=<span class="stringliteral">&quot;biased&quot;</span>)</div>
<div class="line">fes_psir=plumed.read_as_pandas(<span class="stringliteral">&quot;fes_psi_catr.dat&quot;</span>).replace([np.inf, -np.inf], np.nan).dropna()</div>
<div class="line">plt.plot(fes_psir.psi,fes_psir.ffpsir,label=<span class="stringliteral">&quot;reweighted&quot;</span>)</div>
<div class="line">plt.legend()</div>
<div class="line">plt.xlim((-np.pi,np.pi))</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;$\psi$&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$F(\psi)$&quot;</span>)</div>
<div class="line">plt.show()</div>
</div><!-- fragment --><p>When you look at the first graph (i.e., the concatenated time series) you should notice that as you proceed towards the end the frames are coming from the most biased simulation, and thus will have a systematically larger value of \( \phi \). The reweighted ensemble will be in the end quite similar to the original one.</p>
<h2><a class="anchor" id="masterclass-21-3-ex-4"></a>
Exercise 4: Enhancing conformational transitions with multiple-windows umbrella sampling</h2>
<p>So far we only considered the fast transition between the two minima at negative values of \( \phi \). However, alanine dipeptide has another metastable state at positive \( \phi \), that is separated by the minima we have seen by a large barrier. In line of principle, one could use the trick above to discount the effect of any arbitrary biasing potential. For instance, if one had an estimate of a relevant free-energy barrier, a bias potential approximately equal to the negative of the barrier would make the residual free energy basically barrierless. However, this procedure requires knowing the free energy profile in advance. As we will see in the next Masterclass, metadynamics provides exactly a self-healing method that adjusts the bias until dynamics becomes diffusive.</p>
<p>In the context of the static potentials that we are using here, this is a very difficult approach. In the tutorial <a class="el" href="lugano-2.html">Lugano tutorial: Using restraints</a> you can find an attempt to derive a potential cancelling the large barrier and leading to transition between the important metastable states. In this class we will take a more pragmatic approach and directly introduce the method that is commonly used in these situations, namely "multiple windows umbrella sampling".</p>
<p>To do so we will have to run a number of separate simulations, each of them with a bias potential designed to maintain the \( \phi \) variable in a narrow range. If the consecutive windows are sufficiently overlapping, and if the windows span the relevant region in the \( \phi \) variable, we will be able to reconstruct the full free-energy profile.</p>
<p>We will use 32 simulations, with <code>RESTRAINT</code> potentials centered at uniformly spaced values of \( \phi \) in the range between -pi and pi. In order to avoid the repetition of the first potential, recalling the \( \phi \) is periodic, we can generate the list with the command </p><div class="fragment"><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line">at=np.linspace(-np.pi,np.pi,32,endpoint=<span class="keyword">False</span>)</div>
<div class="line">print(at)</div>
</div><!-- fragment --><p>Now you should write a python script that generate 32 plumed input files (you can call them <code>plumed_0.dat</code>, <code>plumed_1.dat</code>, etc) that look like this one </p>
<div style="width: 90%; float:left" id="value_details_eg5"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.9-incomplete-yellow.svg" alt="tested on v2.9" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue"># vim:ft=plumed</span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_m_o_l_i_n_f_o.html" style="color:green">MOLINFO</a> <div class="tooltip">STRUCTURE<div class="right"><b>compulsory keyword </b>
a file in pdb format containing a reference structure. <i></i></div></div>=reference.pdb <span style="display:none;" id="eg5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg5phi" onclick='showPath("eg5","eg5phi")'>phi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg5phi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg5psi" onclick='showPath("eg5","eg5psi")'>psi: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_t_o_r_s_i_o_n.html" style="color:green">TORSION</a> <div class="tooltip">ATOMS<div class="right">the four atoms involved in the torsional angle <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg5psi"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<b name="eg5bb" onclick='showPath("eg5","eg5bb")'>bb: </b><a href="https://www.plumed.org/doc-v2.9/user-doc/html/_r_e_s_t_r_a_i_n_t.html" style="color:green">RESTRAINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg5phi">phi</b> <div class="tooltip">KAPPA<div class="right"><b>compulsory keyword ( default=0.0 )</b>
specifies that the restraint is harmonic and what the values of the force constants
on each of the variables are <i></i></div></div>=200.0 <div class="tooltip">AT<div class="right"><b>compulsory keyword </b>
the position of the restraint <i></i></div></div>=<span style="background-color:yellow">__FILL__</span> <span style="display:none;" id="eg5bb"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<a href="https://www.plumed.org/doc-v2.9/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg5phi">phi</b>,<b name="eg5psi">psi</b>,<b name="eg5bb">bb.bias</b> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=__FILE__ <div class="tooltip">STRIDE<div class="right"><b>compulsory keyword ( default=1 )</b>
the frequency with which the quantities of interest should be output <i></i></div></div>=100 <span style="display:none;" id="eg5"> You cannot view the components that are calculated by each action for this input file. Sorry </span>
<span style="color:blue"># make sure that each simulation writes on a different file</span>
<span style="color:blue"># e.g. colvar_multi_0.dat, colvar_multi_1.dat, @newline</span>
</pre>
<p>Now run the 32 simulations with commands like these ones </p><pre class="fragment">gmx mdrun -plumed plumed_0.dat -s topolA.tpr -nsteps 200000 -x traj_comp_0.xtc
gmx mdrun -plumed plumed_1.dat -s topolA.tpr -nsteps 200000 -x traj_comp_1.xtc
# etc.
</pre><p>As we did before, you should now concatenate the resulting trajectories </p><pre class="fragment">gmx trjcat -cat -f traj_comp_[0-9].xtc traj_comp_[0-9][0-9].xtc -o traj_multi_cat.xtc
</pre><p>and analyze them with plumed driver: </p><pre class="fragment">plumed driver --plumed plumed_0.dat --ixtc traj_multi_cat.xtc --trajectory-stride 100
plumed driver --plumed plumed_1.dat --ixtc traj_multi_cat.xtc --trajectory-stride 100
# etc.
</pre><p> Notice the <code>--trajectory-stride</code> option: we are telling the driver that the trajectory was saved every 100 frames. In this manner, we will be able to recycle the same plumed input file that we used while running the simulations. This approach is more robust than the one we used above, where a single plumed file was used to reproduce all the biases, and is thus recommended in production cases. Also notice that it is common practice to ignore the initial part of each simulation, since it typically contains a transient that would make the final result less robust. For simplicitly, we are not doing it here. Finally, notice that in <a class="el" href="masterclass-21-3.html#masterclass-21-3-ex-3">Exercise 3: Combining statistics from biased and unbiased simulations</a> we were writing a new input file just for writing the three biases. Here instead we recycled the input files used to run the 32 simulations.</p>
<p>We can now read the produced files and process them with our WHAM script </p><div class="fragment"><div class="line">col=[]</div>
<div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(32):</div>
<div class="line">    col.append(plumed.read_as_pandas(<span class="stringliteral">&quot;colvar_multi_&quot;</span> + str(i)+<span class="stringliteral">&quot;.dat&quot;</span>))</div>
<div class="line"><span class="comment"># notice that this is the concatenation of 32 trajectories with 2001 frames each</span></div>
<div class="line">    plt.plot(col[i].phi[2001*i:2001*(i+1)],col[i].psi[2001*i:2001*(i+1)],<span class="stringliteral">&quot;x&quot;</span>)</div>
<div class="line">plt.xlabel(<span class="stringliteral">&quot;$\phi$&quot;</span>)</div>
<div class="line">plt.ylabel(<span class="stringliteral">&quot;$\psi$&quot;</span>)</div>
<div class="line">plt.show()</div>
<div class="line"><span class="comment"># in this graph you can appreciate which region was sampled by each simulation</span></div>
<div class="line"> </div>
<div class="line">bias=np.zeros((len(col[0][<span class="stringliteral">&quot;bb.bias&quot;</span>]),32))</div>
<div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(32):</div>
<div class="line">    bias[:,i]=col[i][<span class="stringliteral">&quot;bb.bias&quot;</span>][-len(bias):]</div>
<div class="line">w=wham.wham(bias,T=kBT)</div>
<div class="line">plt.plot(w[<span class="stringliteral">&quot;logW&quot;</span>])</div>
<div class="line">plt.show()</div>
<div class="line">colvar=col[0]</div>
<div class="line">colvar[<span class="stringliteral">&quot;logweights&quot;</span>]=w[<span class="stringliteral">&quot;logW&quot;</span>]</div>
<div class="line">plumed.write_pandas(colvar,<span class="stringliteral">&quot;bias_multi.dat&quot;</span>)</div>
</div><!-- fragment --><p>Now you can do something similar to what we did before, namely:</p><ul>
<li>write a file to be read by PLUMED.</li>
<li>process it with plumed driver so as to compute the free energy with respect to \( \phi \) and psi</li>
<li>plot the free energy as a function of \( \phi \) and psi</li>
</ul>
<p>How do the resulting free-energy profiles compares with the one we obtained before?</p>
<h2><a class="anchor" id="masterclass-21-3-ex-5"></a>
Exercise 5: Computing populations and errors</h2>
<p>Now that you have a simulation that sampled all the relevant metastable states, you can analyze it in many different manners. In particular, you can compute the average of any quantity just using the weights that we obtained. This can be done directly with PLUMED, as we have seen in <a class="el" href="masterclass-21-2.html">PLUMED Masterclass 21.2: Statistical errors in MD</a>, using the <a class="el" href="_a_v_e_r_a_g_e.html">AVERAGE</a> command. However, we will here use Python to compute averages, since this will make it easier to compute their statistical errors with bootstrap.</p>
<p>To complete this exercise you should compute the average value and the statistical error of the following quantities:</p><ul>
<li>Population of the metastable state B defined as 0&lt; \( \phi \)&lt;2. Notice that the exact definition is not very important if the minimum is clearly delimited by high free-energy barriers (i.e., low probability regions).</li>
<li>Free-energy difference between the state B defined as 0&lt; \( \phi \)&lt;2 and the state A defined as -pi&lt; \( \phi \)&lt;0. Notice that the free-energy difference is defined as -kBT log PB/PA, where PB is the population of state B and PA the population of state A.</li>
<li>Average value of \( \phi \) in state A and in state B. Warning: how to compute the average of an angle?</li>
</ul>
<p>For each of these quantities, you should also compute the standard error. It is here recommended to compute the error using boostrap. You can do so by adjusting the following script </p><div class="fragment"><div class="line"><span class="comment"># number of blocks</span></div>
<div class="line">NB=10</div>
<div class="line"><span class="comment"># we reshape the bias so that it appears as NB times frames of each traj times number of biases</span></div>
<div class="line">bb=bias.reshape((32,-1,32))[:,-2000:,:].reshape((32,NB,2000//NB,32))</div>
<div class="line"><span class="comment"># we reshape the trajectory so that it appears as NB times frames of each traj times number of biases</span></div>
<div class="line">cc=np.array(col[0].phi).reshape((32,-1))[:,-2000:].reshape((32,NB,2000//NB))</div>
<div class="line"> </div>
<div class="line"><span class="comment"># we first analyse the complete trajectory:</span></div>
<div class="line">tr=cc.flatten()</div>
<div class="line">is_in_B=np.int_(np.logical_and(tr&gt;0,tr&lt;2))</div>
<div class="line">w0=wham.wham(bb.reshape((-1,32)),T=kBT)</div>
<div class="line"> </div>
<div class="line">print(<span class="stringliteral">&quot;population:&quot;</span>,np.average(is_in_B,weights=np.exp(w0[<span class="stringliteral">&quot;logW&quot;</span>])))</div>
<div class="line">pop=[]</div>
<div class="line"><span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(200):</div>
<div class="line">    <span class="comment"># we then analyze the bootstrapped trajectories</span></div>
<div class="line">    print(i)</div>
<div class="line">    c=np.random.choice(NB,NB)</div>
<div class="line">    w=wham.wham(bb[:,c,:,:].reshape((-1,32)),T=kBT)</div>
<div class="line">    tr=cc[:,c,:].flatten()</div>
<div class="line">    is_in_B=np.int_(np.logical_and(tr&gt;0,tr&lt;2))</div>
<div class="line">    pop.append(np.average(is_in_B,weights=np.exp(w[<span class="stringliteral">&quot;logW&quot;</span>])))</div>
</div><!-- fragment --><h2><a class="anchor" id="masterclass-21-3-ex-6"></a>
Exercise 6: Effect of initial conditions</h2>
<p>Repeat exercise <a class="el" href="masterclass-21-3.html#masterclass-21-3-ex-4">Exercise 4: Enhancing conformational transitions with multiple-windows umbrella sampling</a> using as an input file <code>topolB.tpr</code>. This will make the simulations start from the minimum in B. Plot the free energy as a function of \( \phi \) and as a function of psi. How does it differ from the one obtained in solving <a class="el" href="masterclass-21-3.html#masterclass-21-3-ex-4">Exercise 4: Enhancing conformational transitions with multiple-windows umbrella sampling</a>? </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
<!--    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>  -->
    <li class="footer">   <!--- Generated by -->
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
